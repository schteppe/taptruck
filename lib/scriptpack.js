goo.AxisAlignedCamControlScript=function(e,t,o){"use strict";function n(){function t(t,i){i.axis=new e(e.UNIT_Z),i.upAxis=new e(e.UNIT_Y),n(t,i,t.view),i.currentView=t.view,i.lookAtPoint=new e(e.ZERO),i.distance=t.distance,i.smoothness=Math.pow(o.clamp(t.smoothness,0,1),.3),i.axisAlignedDirty=!0}function n(t,o,n){if(o.currentView!==n){switch(o.currentView=n,n){case"XY":o.axis.setVector(e.UNIT_Z),o.upAxis.setVector(e.UNIT_Y);break;case"ZY":o.axis.setVector(e.UNIT_X),o.upAxis.setVector(e.UNIT_Y)}o.axisAlignedDirty=!0}}function i(e,t){if(e.view!==t.currentView&&(t.axisAlignedDirty=!0),t.axisAlignedDirty){var o=t.entity,n=o.transformComponent.transform;n.translation.setVector(t.axis).scale(t.distance).addVector(t.lookAtPoint),n.lookAt(t.lookAtPoint,t.upAxis),o.transformComponent.setUpdated(),t.axisAlignedDirty=!1}}function r(){}return{setup:t,update:i,cleanup:r}}return n.externals={key:"AxisAlignedCamControlScript",name:"Axis-aligned Camera Control",description:"Aligns a camera along an axis, and enables switching between them.",parameters:[{key:"whenUsed",name:"When Camera Used",description:"Script only runs when the camera to which it is added is being used.","default":!0,type:"boolean"},{key:"distance",name:"Distance",type:"float",description:"Camera distance from lookat point",control:"slider","default":1,min:1,max:1e3},{key:"view",type:"string","default":"XY",control:"select",options:["XY","ZY"]}]},n}(goo.Vector3,goo.ScriptUtils,goo.MathUtils),goo.BasicControlScript=function(e,t){"use strict";function o(o){o=o||{},this.domElement=void 0===o.domElement?null:o.domElement.domElement||o.domElement,this.name="BasicControlScript",this.movementSpeed=10,this.rollSpeed=2,this.movementSpeedMultiplier=1,this.mouseStatus=0,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.moveVector=new e(0,0,0),this.rotationVector=new e(0,0,0),this.multiplier=new e(1,1,1),this.rotationMatrix=new t,this.tmpVec=new e,this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)},this.keydown=function(e){if(!e.altKey){switch(e.keyCode){case 16:this.movementSpeedMultiplier=.1;break;case 87:this.moveState.forward=1;break;case 83:this.moveState.back=1;break;case 65:this.moveState.left=1;break;case 68:this.moveState.right=1;break;case 82:this.moveState.up=1;break;case 70:this.moveState.down=1;break;case 38:this.moveState.pitchUp=1;break;case 40:this.moveState.pitchDown=1;break;case 37:this.moveState.yawLeft=1;break;case 39:this.moveState.yawRight=1;break;case 81:this.moveState.rollLeft=1;break;case 69:this.moveState.rollRight=1}this.updateMovementVector(),this.updateRotationVector()}},this.keyup=function(e){switch(e.keyCode){case 16:this.movementSpeedMultiplier=1;break;case 87:this.moveState.forward=0;break;case 83:this.moveState.back=0;break;case 65:this.moveState.left=0;break;case 68:this.moveState.right=0;break;case 82:this.moveState.up=0;break;case 70:this.moveState.down=0;break;case 38:this.moveState.pitchUp=0;break;case 40:this.moveState.pitchDown=0;break;case 37:this.moveState.yawLeft=0;break;case 39:this.moveState.yawRight=0;break;case 81:this.moveState.rollLeft=0;break;case 69:this.moveState.rollRight=0}this.updateMovementVector(),this.updateRotationVector()},this.mousedown=function(e){this.domElement!==document&&this.domElement.focus(),e.preventDefault(),e=e.touches&&1===e.touches.length?e.touches[0]:e,this.mouseDownX=e.pageX,this.mouseDownY=e.pageY,this.mouseStatus=1,document.addEventListener("mousemove",this.mousemove,!1),document.addEventListener("mouseup",this.mouseup,!1),document.addEventListener("touchmove",this.mousemove,!1),document.addEventListener("touchend",this.mouseup,!1)}.bind(this),this.mousemove=function(e){this.mouseStatus>0&&(e=e.touches&&1===e.touches.length?e.touches[0]:e,this.moveState.yawLeft=e.pageX-this.mouseDownX,this.moveState.pitchDown=e.pageY-this.mouseDownY,this.updateRotationVector(),this.mouseDownX=e.pageX,this.mouseDownY=e.pageY)}.bind(this),this.mouseup=function(e){this.mouseStatus&&(e.preventDefault(),this.mouseStatus=0,this.moveState.yawLeft=this.moveState.pitchDown=0,this.updateRotationVector(),document.removeEventListener("mousemove",this.mousemove),document.removeEventListener("mouseup",this.mouseup),document.removeEventListener("touchmove",this.mousemove),document.removeEventListener("touchend",this.mouseup))}.bind(this),this.updateMovementVector=function(){var e=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-e+this.moveState.back},this.updateRotationVector=function(){this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft},this.getContainerDimensions=function(){return this.domElement!==document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}},this.domElement&&this.setupMouseControls(),this.updateMovementVector(),this.updateRotationVector()}return o.prototype.setupMouseControls=function(){this.domElement.setAttribute("tabindex",-1),this.domElement.addEventListener("mousedown",this.mousedown,!1),this.domElement.addEventListener("touchstart",this.mousedown,!1),this.domElement.addEventListener("keydown",this.keydown.bind(this),!1),this.domElement.addEventListener("keyup",this.keyup.bind(this),!1)},o.prototype.externals=function(){return[{variable:"movementSpeed",type:"number"},{variable:"rollSpeed",type:"number"}]},o.prototype.run=function(t,o,n){n&&!this.domElement&&n.domElement&&(this.domElement=n.domElement,this.setupMouseControls());var i=t.transformComponent,r=i.transform,a=t._world.tpf,s=a*this.movementSpeed*this.movementSpeedMultiplier,c=a*this.rollSpeed*this.movementSpeedMultiplier;(!this.moveVector.equals(e.ZERO)||!this.rotationVector.equals(e.ZERO)||this.mouseStatus>0)&&(r.translation.x+=this.moveVector.x*s,r.translation.y+=this.moveVector.y*s,r.translation.z+=this.moveVector.z*s,this.tmpVec.x+=-this.rotationVector.x*c*this.multiplier.x,this.tmpVec.y+=this.rotationVector.y*c*this.multiplier.y,this.tmpVec.z+=this.rotationVector.z*c*this.multiplier.z,r.rotation.fromAngles(this.tmpVec.x,this.tmpVec.y,this.tmpVec.z),this.mouseStatus>0&&(this.moveState.yawLeft=0,this.moveState.pitchDown=0,this.updateRotationVector()),i.setUpdated())},o}(goo.Vector3,goo.Matrix3x3),goo.ButtonScript=function(e,t,o,n,i){"use strict";function r(){function e(e,o){o.button=["Any","Left","Middle","Right"].indexOf(e.button)-1,o.button<-1&&(o.button=-1),o.renderToPickHandler=function(){o.skipUpdateBuffer=!0},i.addListener("ButtonScript.renderToPick",o.renderToPickHandler,!1),o.mouseState={x:0,y:0,down:!1,downOnEntity:!1,overEntity:!1},o.listeners={mousedown:function(n){if(e.whenUsed){var i=r(n);(i===o.button||-1===o.button)&&(o.mouseState.down=!0,t(e,o,n),a(e,o,"mousedown"))}},mouseup:function(n){if(e.whenUsed){var i=r(n);(i===o.button||-1===o.button)&&(o.mouseState.down=!1,t(e,o,n),o.mouseState.downOnEntity&&a(e,o,"click"),a(e,o,"mouseup"))}},dblclick:function(n){if(e.whenUsed){var i=r(n);(i===o.button||-1===o.button)&&(o.mouseState.down=!1,t(e,o,n),a(e,o,"dblclick"))}},mousemove:function(n){e.whenUsed&&e.enableOnMouseMove&&(o.mouseState.down=!1,t(e,o,n),a(e,o,"mousemove"))},touchstart:function(t){if(e.whenUsed){o.mouseState.down=!0;var n=t.targetTouches,i=o.domElement.getBoundingClientRect();o.mouseState.x=n[0].pageX-i.left,o.mouseState.y=n[0].pageY-i.top,a(e,o,"touchstart")}},touchend:function(){e.whenUsed&&(o.mouseState.down=!1,a(e,o,"touchend"))}};for(var n in o.listeners)o.domElement.addEventListener(n,o.listeners[n])}function t(e,t,o){var n=t.domElement.getBoundingClientRect();t.mouseState.x=o.pageX-n.left,t.mouseState.y=o.pageY-n.top}function o(e,t){t.skipUpdateBuffer=!1}function n(e,t){for(var o in t.listeners)t.domElement.removeEventListener(o,t.listeners[o]);i.removeListener("ButtonScript.renderToPick",t.renderToPickHandler)}function r(e){var t=e.button;return 0===t&&(e.altKey?t=2:e.shiftKey&&(t=1)),t}function a(e,t,o){var n=t.entity._world.gooRunner,r=n.pickSync(t.mouseState.x,t.mouseState.y,t.skipUpdateBuffer);t.skipUpdateBuffer||i.emit("ButtonScript.renderToPick");var a=n.world.entityManager.getEntityByIndex(r.id);t.mouseState.downOnEntity=!1,a===t.entity&&(i.emit(e.channel+"."+o,{type:o,entity:a}),("mousedown"===o||"touchstart"===o)&&(t.mouseState.downOnEntity=!0),e.linkUrl&&"click"===o&&window.open(e.linkUrl,e.linkTarget)),"mousemove"!==o||t.mouseState.overEntity||a!==t.entity||i.emit(e.channel+".mouseover",{type:"mouseover",entity:a}),"mousemove"===o&&t.mouseState.overEntity&&a!==t.entity&&i.emit(e.channel+".mouseout",{type:"mouseout",entity:a}),t.mouseState.overEntity=a===t.entity}return{setup:e,update:o,cleanup:n}}return r.externals={key:"ButtonScript",name:"Button",description:"Enables an entity to be interacted with using click or touch.",parameters:[{key:"whenUsed",type:"boolean","default":!0},{key:"button",name:"button",description:"Only interact with this mouse button.",type:"string",control:"select","default":"Any",options:["Any","Left","Middle","Right"]},{key:"linkUrl",name:"linkUrl",description:"URL to open when clicking the entity. Leave this field empty to disable.",type:"string","default":""},{key:"linkTarget",name:"linkTarget",description:"The window to open the link in.",type:"string","default":"_blank"},{key:"channel",name:"channel",description:"Event channel to emit to. Will emit channel.click, .mousedown, .mouseup, .mouseover, .mouseout, .dblclick, .touchstart, .touchend",type:"string","default":"button"},{key:"enableOnMouseMove",name:"enableOnMouseMove",description:"Enables .mousemove, .mouseover, and .mouseout events. For larger scenes, this might be worth turning off, for better performance.",type:"boolean","default":!0}]},r}(goo.Vector3,goo.Scripts,goo.ScriptUtils,goo.Renderer,goo.SystemBus),goo.CannonPickScript=function(e,t,o,n,i){"use strict";function r(){function t(e){var t=e[0].clientX,o=e[0].clientY,n=e[1].clientX,i=e[1].clientY,r=(t+n)/2,a=(o+i)/2;return[r,a]}function o(o,n){y=["Any","Left","Middle","Right"].indexOf(o.pickButton)-1,-1>y&&(y=-1),g=n.goingToLookAt,u=new e(e.UNIT_Y),p=new e(e.UNIT_X).invert(),m=new e,f=new e,h=new e;var i=n.world.gooRunner.renderer;w=i._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/i.svg.currentScale:1,S=n.world.getSystem("CannonSystem");var r=new a.Sphere(.1),s=n.jointBody=new a.RigidBody(0,r);s.collisionFilterGroup=2,s.collisionFilterMask=2,S.world.add(s),v={x:0,y:0,ox:0,oy:0,dx:0,dy:0,down:!1};var c=n.listeners={mousedown:function(e){if(!o.whenUsed||n.entity===n.activeCameraEntity){var t=e.button;0===t&&(e.altKey?t=2:e.shiftKey&&(t=1)),(t===y||-1===y)&&(v.down=!0,v.ox=v.x=e.clientX,v.oy=v.y=e.clientY)}},mouseup:function(e){var t=e.button;0===t&&(e.altKey?t=2:e.shiftKey&&(t=1)),(t===y||-1===y)&&(v.down=!1,v.dx=v.dy=0)},mousemove:function(e){o.whenUsed&&n.entity!==n.activeCameraEntity||v.down&&(v.x=e.clientX,v.y=e.clientY,n.dirty=!0)},mouseleave:function(){v.down=!1,v.ox=v.x,v.oy=v.y},touchstart:function(e){if(!o.whenUsed||n.entity===n.activeCameraEntity){if(v.down=2===e.targetTouches.length,!v.down)return;var i=t(e.targetTouches);v.ox=v.x=i[0],v.oy=v.y=i[1]}},touchmove:function(e){if(!o.whenUsed||n.entity===n.activeCameraEntity){if(!v.down)return;var i=t(e.targetTouches);v.x=i[0],v.y=i[1]}},touchend:function(){v.down=!1,v.ox=v.x,v.oy=v.y}};for(var d in c)n.domElement.addEventListener(d,c[d]);n.dirty=!0}function r(t,o){v.dx=v.x-v.ox,v.dy=v.y-v.oy,v.ox=v.x,v.oy=v.y;var i=n.mainCamera;if(i&&v.down&&!o.mouseConstraint){for(var r=[],s=o.world.by.system("CannonSystem").toArray(),u=0;u<s.length;u++){var p=s[u].cannonRigidbodyComponent.body;p&&p.shape instanceof a.Box&&p.motionstate===a.Body.DYNAMIC&&r.push(p)}var m=i.getPickRay(v.x,v.y,window.innerWidth,window.innerHeight),f=new a.Vec3(m.origin.x,m.origin.y,m.origin.z),h=new a.Vec3(m.direction.x,m.direction.y,m.direction.z),y=new a.Ray(f,h),g=y.intersectBodies(r);if(g.length){var p=g[0].body,w=g[0].point;c(t,o,w.x,w.y,w.z,p,m.direction.mul(-1))}}else if(i&&v.down&&o.mouseConstraint&&(0!==v.dx||0!==v.dy)){var i=n.mainCamera,m=i.getPickRay(v.x,v.y,window.innerWidth,window.innerHeight),S=new e;x.rayIntersect(m,S,!0),d(t,o,S)}else v.down||l(t,o)}function s(e,t){for(var o in t.listeners)t.domElement.removeEventListener(o,t.listeners[o])}function c(t,o,n,i,r,s,c){o.constrainedBody=s;var d=new a.Vec3(n,i,r).vsub(o.constrainedBody.position),l=o.constrainedBody.quaternion.inverse(),u=l.vmult(d);o.jointBody.position.set(n,i,r),o.mouseConstraint=new a.PointToPointConstraint(o.constrainedBody,u,o.jointBody,new a.Vec3(0,0,0)),S.world.addConstraint(o.mouseConstraint);var p=new e(n,i,r);x.constant=p.dot(c),x.normal.setVector(c)}function d(e,t,o){t.jointBody.position.set(o.x,o.y,o.z),t.mouseConstraint.update()}function l(e,t){S.world.removeConstraint(t.mouseConstraint),t.mouseConstraint=!1}var u,p,m,f,h,y,g,v,w,S,x=new i;return{setup:o,update:r,cleanup:s}}var a=window.CANNON;return r.externals={key:"CannonPickScript",name:"Cannon.js Body Pick",description:"Enables the user to physically pick a Cannon.js physics body and drag it around.",parameters:[{key:"whenUsed",type:"boolean","default":!0},{key:"pickButton",name:"Pan button",description:"Pick with this button",type:"string",control:"select","default":"Any",options:["Any","Left","Middle","Right"]},{key:"useForceNormal",name:"Use force normal",type:"boolean","default":!1},{key:"forceNormal",name:"Force normal","default":[0,0,1],type:"vec3"}]},r}(goo.Vector3,goo.Scripts,goo.ScriptUtils,goo.Renderer,goo.Plane),goo.WASDControlScript=function(e,t,o){"use strict";function n(){function t(){y.x=m.strafeLeft-m.strafeRight,y.z=m.forward-m.back}function n(e){if(!e.altKey)switch(o.keyForCode(e.keyCode)){case p.crawlKey:m.speed=p.crawlSpeed;break;case p.forwardKey:m.forward=1,t();break;case p.backKey:m.back=1,t();break;case p.strafeLeftKey:m.strafeLeft=1,t();break;case p.strafeRightKey:m.strafeRight=1,t()}}function i(e){if(!e.altKey)switch(o.keyForCode(e.keyCode)){case p.crawlKey:m.speed=p.walkSpeed;break;case p.forwardKey:m.forward=0,t();break;case p.backKey:m.back=0,t();break;case p.strafeLeftKey:m.strafeLeft=0,t();break;case p.strafeRightKey:m.strafeRight=0,t()}}function r(e){e.setAttribute("tabindex",-1),e.addEventListener("keydown",n,!1),e.addEventListener("keyup",i,!1)}function a(e,t){p=e,t.moveState=m={strafeLeft:0,strafeRight:0,forward:0,back:0,crawling:!1,speed:e.walkSpeed},d=t.entity,l=d.transformComponent,u=l.transform,r(t.domElement)}function s(t,o){if(!(y.equals(e.ZERO)||t.whenUsed&&o.entity!==o.activeCameraEntity)){g.set(f.x*y.z+h.x*y.x,f.y*y.z+h.y*y.x,f.z*y.z+h.z*y.x),g.normalize();var n=o.world.tpf*m.speed;g.mul(n);var i=u.rotation;i.applyPost(g),u.translation.add(g),l.setUpdated()}}function c(e,t){t.domElement.removeEventListener("keydown",n,!1),t.domElement.removeEventListener("keyup",i,!1)}var d,l,u,p,m,f=new e(0,0,-1),h=new e(-1,0,0),y=new e,g=new e;return{setup:a,update:s,cleanup:c}}return n.externals={key:"WASD",name:"WASD Control",description:"Enables moving via the WASD keys",parameters:[{key:"whenUsed",type:"boolean",name:"When Camera Used",description:"Script only runs when the camera to which it is added is being used.","default":!0},{key:"crawlKey",type:"string",control:"key","default":"Shift"},{key:"forwardKey",type:"string",control:"key","default":"W"},{key:"backKey",type:"string",control:"key","default":"S"},{key:"strafeLeftKey",type:"string",control:"key","default":"A"},{key:"strafeRightKey",type:"string",control:"key","default":"D"},{key:"walkSpeed",type:"int",control:"slider","default":10,min:1,max:100,exponential:!0},{key:"crawlSpeed",control:"slider",type:"int","default":1,min:.1,max:10,exponential:!0}]},n}(goo.Vector3,goo.Scripts,goo.ScriptUtils),goo.MouseLookControlScript=function(e,t,o,n){"use strict";function i(){function e(e){f.whenUsed&&m.entity!==m.activeCameraEntity||(-1===p||e.button===p)&&(y=!0,g=w=e.clientX,v=S=e.clientY)}function i(){document.pointerLockElement||n.requestPointerLock()}function r(e){f.whenUsed&&m.entity!==m.activeCameraEntity||y&&(void 0!==e.movementX?(w+=e.movementX,S+=e.movementY):(w=e.clientX,S=e.clientY))}function a(){y=!1}function s(){y=!!document.pointerLockElement,document.pointerLockElement?m.domElement.removeEventListener("mousedown",i):m.domElement.addEventListener("mousedown",i)}function c(o,c){m=c,f=o,p=["Any","Left","Middle","Right","None"].indexOf(o.button)-1,-1>p&&(p=-1);var d=c.domElement;3===p?(document.addEventListener("pointerlockchange",s),document.addEventListener("mousemove",r),d.addEventListener("mousedown",i),n.requestPointerLock()):(d.addEventListener("mousedown",e),d.addEventListener("mouseup",a),d.addEventListener("mouseleave",a),d.addEventListener("mousemove",r)),u=new t;var l=c.entity.transformComponent.transform.rotation;l.toAngles(u),h=u.data[1]}function d(e,t){if(w!==g||S!==v){var n=w-g,i=S-v,r=t.entity,a=r.transformComponent.transform.rotation;a.toAngles(u);var s=u.data[0],c=u.data[1],d=e.maxAscent*o.DEG_TO_RAD,l=e.minAscent*o.DEG_TO_RAD;s=o.clamp(s-i*e.speed/200,l,d);var p=e.maxAzimuth*o.DEG_TO_RAD-h,m=e.minAzimuth*o.DEG_TO_RAD-h;c-=n*e.speed/200,e.clampAzimuth&&(c=o.radialClamp(c,m,p)),a.fromAngles(s,c,0),r.transformComponent.setUpdated(),g=w,v=S}}function l(t,o){var c=o.domElement;3===p?(n.exitPointerLock(),document.removeEventListener("mousemove",r),c.removeEventListener("mousedown",i),document.removeEventListener("pointerlockchange",s)):(c.removeEventListener("mousemove",r),c.removeEventListener("mousedown",e),c.removeEventListener("mouseup",a),c.removeEventListener("mouseleave",a))}var u,p,m,f,h,y=!1,g=0,v=0,w=0,S=0;return{setup:c,update:d,cleanup:l}}return i.externals={key:"MouseLookScript",name:"Mouse Look Control",description:"Click and drag to change rotation of entity, usually a camera",parameters:[{key:"whenUsed",type:"boolean",name:"When Camera Used",description:"Script only runs when the camera to which it is added is being used.","default":!0},{key:"button",name:"Mouse button",type:"string",control:"select","default":"Left",options:["Any","Left","Middle","Right","None"]},{key:"speed",name:"Turn Speed",type:"float",control:"slider","default":1,min:-10,max:10,scale:.1},{key:"maxAscent",name:"Max Ascent",type:"float",control:"slider","default":89.95,min:-89.95,max:89.95},{key:"minAscent",name:"Min Ascent",type:"float",control:"slider","default":-89.95,min:-89.95,max:89.95},{key:"clampAzimuth","default":!1,type:"boolean"},{key:"minAzimuth",description:"Maximum arc the camera can reach clockwise of the target point","default":-90,type:"int",control:"slider",min:-180,max:0},{key:"maxAzimuth",description:"Maximum arc the camera can reach counter-clockwise of the target point","default":90,type:"int",control:"slider",min:0,max:180}]},i}(goo.Scripts,goo.Vector3,goo.MathUtils,goo.GameUtils),goo.FlyControlScript=function(e,t,o){"use strict";function n(){function n(e,t){s.setup(e,t),a.setup(e,t)}function i(e,t){s.update(e,t),a.update(e,t)}function r(e,t){s.cleanup(e,t),a.cleanup(e,t)}var a=e.create(t),s=e.create(o);return{setup:n,cleanup:r,update:i}}var i=t.externals.parameters,r=o.externals.parameters,a=i.concat(r.slice(1));return n.externals={key:"FlyControlScript",name:"Fly Control",description:"This is a combo of WASDscript and mouselookscript",parameters:a},n}(goo.Scripts,goo.WASDControlScript,goo.MouseLookControlScript),goo.GroundBoundMovementScript=function(e){"use strict";function t(t){t=t||{};for(var o in n)this[o]="boolean"==typeof n[o]?void 0!==t[o]?t[o]===!0:n[o]:isNaN(n[o])?n[o]instanceof e?t[o]?new e(t[o]):(new e).set(n[o]):t[o]||n[o]:isNaN(t[o])?n[o]:t[o];this.groundContact=1,this.targetVelocity=new e,this.targetHeading=new e,this.acceleration=new e,this.torque=new e,this.groundHeight=0,this.groundNormal=new e,this.controlState={run:0,strafe:0,jump:0,yaw:0,roll:0,pitch:0}}var o=new e,n={gravity:-9.81,worldFloor:-(1/0),jumpImpulse:95,accLerp:.1,rotLerp:.1,modForward:1,modStrafe:.7,modBack:.4,modTurn:.3};return t.prototype.setTerrainSystem=function(e){this.terrainScript=e},t.prototype.getTerrainSystem=function(){return this.terrainScript},t.prototype.getTerrainHeight=function(e){var t=this.getTerrainSystem().getTerrainHeightAt(e.data);return null===t&&(t=this.worldFloor),t},t.prototype.getTerrainNormal=function(e){return this.getTerrainSystem().getTerrainNormalAt(e.data)},t.prototype.applyForward=function(e){this.controlState.run=e},t.prototype.applyStrafe=function(e){this.controlState.strafe=e},t.prototype.applyJump=function(e){this.controlState.jump=e},t.prototype.applyTurn=function(e){this.controlState.yaw=e},t.prototype.applyJumpImpulse=function(e){return this.groundContact&&(this.controlState.jump?(e=this.jumpImpulse,this.controlState.jump=0):e=0),e},t.prototype.applyDirectionalModulation=function(e,t,o){e*=this.modStrafe,o*=o>0?this.modForward:this.modBack,this.targetVelocity.set(e,this.applyJumpImpulse(t),o)},t.prototype.applyTorqueModulation=function(e,t,o){this.targetHeading.set(e,t*this.modTurn,o)},t.prototype.applyGroundNormalInfluence=function(){var e=Math.abs(Math.cos(this.groundNormal.data[0])),t=Math.abs(Math.cos(this.groundNormal.data[2]));this.targetVelocity.data[0]*=e,this.targetVelocity.data[2]*=t},t.prototype.updateTargetVectors=function(e){this.applyDirectionalModulation(this.controlState.strafe,this.gravity,this.controlState.run),e.rotation.applyPost(this.targetVelocity),this.applyGroundNormalInfluence(),this.applyTorqueModulation(this.controlState.pitch,this.controlState.yaw,this.controlState.roll)},t.prototype.computeAcceleration=function(e,t,n){return o.set(n),e.transformComponent.transform.rotation.applyPost(o),o.sub(t),o.lerp(n,this.accLerp),o.data[1]=n.data[1],o},t.prototype.computeTorque=function(e,t){return o.set(t),o.sub(e),o.lerp(t,this.rotLerp),o},t.prototype.updateVelocities=function(e){var t=e.movementComponent.getVelocity(),o=e.movementComponent.getRotationVelocity();this.acceleration.set(this.computeAcceleration(e,t,this.targetVelocity)),this.torque.set(this.computeTorque(o,this.targetHeading))},t.prototype.applyAccelerations=function(e){e.movementComponent.addVelocity(this.acceleration),e.movementComponent.addRotationVelocity(this.torque)},t.prototype.updateGroundNormal=function(e){this.groundNormal.set(this.getTerrainNormal(e.translation))},t.prototype.checkGroundContact=function(e,t){this.groundHeight=this.getTerrainHeight(t.translation),t.translation.data[1]<=this.groundHeight?(this.groundContact=1,this.updateGroundNormal(t)):this.groundContact=0},t.prototype.applyGroundContact=function(e,t){this.groundHeight>=t.translation.data[1]&&(t.translation.data[1]=this.groundHeight,e.movementComponent.velocity.data[1]<0&&(e.movementComponent.velocity.data[1]=0))},t.prototype.run=function(e){var t=e.transformComponent.transform;this.checkGroundContact(e,t),this.updateTargetVectors(t),this.updateVelocities(e),this.applyAccelerations(e),this.applyGroundContact(e,t)},t}(goo.Vector3),goo.HeightMapBoundingScript=function(e){"use strict";function t(e){this.matrixData=e,this.width=e.length-1}return t.prototype.getMatrixData=function(){return this.matrixData},t.prototype.getPointInMatrix=function(e,t){return this.matrixData[e][t]},t.prototype.getAt=function(e,t){return 0>e||e>this.width||0>t||t>this.width?0:this.getPointInMatrix(e,t)},t.prototype.getInterpolated=function(e,t){var o=this.getAt(Math.ceil(e),Math.ceil(t)),n=this.getAt(Math.ceil(e),Math.floor(t)),i=this.getAt(Math.floor(e),Math.ceil(t)),r=this.getAt(Math.floor(e),Math.floor(t)),a=e-Math.floor(e),s=t-Math.floor(t),c=o*a+i*(1-a),d=n*a+r*(1-a),l=c*s+d*(1-s);return l},t.prototype.getTriangleAt=function(e,t){var o,n=Math.ceil(e),i=Math.floor(e),r=Math.ceil(t),a=Math.floor(t),s=e-i,c=t-a,d={x:i,y:r,z:this.getAt(i,r)},l={x:n,y:a,z:this.getAt(n,a)};return o=1-c>s?{x:i,y:a,z:this.getAt(i,a)}:{x:n,y:r,z:this.getAt(n,r)},[d,l,o]},t.prototype.getPreciseHeight=function(t,o){var n=this.getTriangleAt(t,o),i=e.barycentricInterpolation(n[0],n[1],n[2],{x:t,y:o,z:0});return i.z},t.prototype.run=function(e){var t=e.transformComponent.transform.translation;t.data[1]=this.getInterpolated(t.data[2],t.data[0])},t}(goo.MathUtils),goo.LensFlareScript=function(e,t,o,n,i){"use strict";function r(){function e(e){v.size=e,v.splash=t.createSplashTexture(512,{trailStartRadius:25,trailEndRadius:0}),v.ring=t.createFlareTexture(e,{steps:w.ring,startRadius:e/4,endRadius:e/2}),v.dot=t.createFlareTexture(e,{steps:w.dot,startRadius:0,endRadius:e/2}),v.bell=t.createFlareTexture(e,{steps:w.bell,startRadius:0,endRadius:e/2}),v["default"]=t.createFlareTexture(e,{steps:w.none,startRadius:0,endRadius:e/2})}function o(e,t,o,n,i){for(var r=0;r<e.length;r++){var a=e[r];y.push(new s(t,a.tx,a.displace,a.size,a.intensity*f,o,n,i,v,l))}return y}function n(e){for(var t=0;t<e.length;t++)e[t].quad.removeFromWorld()}function i(t,o){f=t.intensity,h=new a(100*t.edgeRelevance);var n=g;t.highRes&&(n*=4),v.size!==n&&e(n),y=[],d=o.entity,l=o.world,u=!1,m=[t.color[0],t.color[1],t.color[2],1],p=[{size:2.53,tx:"bell",intensity:.7,displace:1},{size:.53,tx:"dot",intensity:.7,displace:1},{size:.83,tx:"bell",intensity:.2,displace:.8},{size:.4,tx:"ring",intensity:.1,displace:.6},{size:.3,tx:"bell",intensity:.1,displace:.4},{size:.6,tx:"bell",intensity:.1,displace:.3},{size:.3,tx:"dot",intensity:.1,displace:.15},{size:.22,tx:"ring",intensity:.03,displace:-.25},{size:.36,tx:"dot",intensity:.05,displace:-.5},{size:.8,tx:"ring",intensity:.1,displace:-.8},{size:.86,tx:"bell",intensity:.2,displace:-1.1},{size:1.3,tx:"ring",intensity:.05,displace:-1.5}]}function r(){n(y),y=[]}function c(e,t){if(t.entity.isVisible!==!1){h.updateFrameGeometry(d,t.activeCameraEntity),u||(y=o(p,m,e.scale,e.edgeDampen,e.edgeScaling),u=!0);for(var i=0;i<y.length;i++)y[i].updatePosition(h)}else u&&(n(y),u=!1)}var d,l,u,p,m,f,h,y=[],g=64,v={},w={splash:{trailStartRadius:25,trailEndRadius:0},ring:[{fraction:0,value:0},{fraction:.7,value:0},{fraction:.92,value:1},{fraction:.98,value:0}],dot:[{fraction:0,value:1},{fraction:.3,value:.75},{fraction:.5,value:.45},{fraction:.65,value:.21},{fraction:.75,value:.1},{fraction:.98,value:0}],bell:[{fraction:0,value:1},{fraction:.15,value:.75},{fraction:.3,value:.5},{fraction:.4,value:.25},{fraction:.75,value:.05},{fraction:.98,value:0}],none:[{fraction:0,value:1},{fraction:1,value:0}]};return{setup:i,update:c,cleanup:r}}function a(t){this.camRot=null,this.distance=0,this.offset=0,this.centerRatio=0,this.positionVector=new e,this.distanceVector=new e,this.centerVector=new e,this.displacementVector=new e,this.edgeRelevance=t}function s(t,r,a,s,c,d,l,u,p,m){this.sizeVector=new e(s,s,s),this.sizeVector.mul(d),this.positionVector=new e,this.flareVector=new e,this.intensity=c,this.displace=a,this.color=[t[0]*c,t[1]*c,t[2]*c,1],this.edgeDampen=l,this.edgeScaling=u;var f=new o(n.uber,"flareShader");f.uniforms.materialEmissive=this.color,f.uniforms.materialDiffuse=[0,0,0,1],f.uniforms.materialAmbient=[0,0,0,1],f.uniforms.materialSpecular=[0,0,0,1];var h=p[r];f.setTexture("DIFFUSE_MAP",h),f.setTexture("EMISSIVE_MAP",h),f.blendState.blending="AdditiveBlending",f.blendState.blendEquation="AddEquation",f.blendState.blendSrc="OneFactor",f.blendState.blendDst="OneFactor",f.depthState.enabled=!1,f.depthState.write=!1,f.cullState.enabled=!1;var y=new i(1,1),g=m.createEntity(y,f);g.meshRendererComponent.cullMode="Never",g.addToWorld(),this.material=f,this.quad=g}return r.externals={key:"LensFlareScript",name:"Lens Flare Script",description:"Makes an entity shine with some lensflare effect.",parameters:[{key:"scale",name:"Scale",type:"float",description:"Scale of flare quads",control:"slider","default":1,min:.01,max:2},{key:"intensity",name:"Intensity",type:"float",description:"Intensity of Effect",control:"slider","default":1,min:.01,max:2},{key:"edgeRelevance",name:"Edge Relevance",type:"float",description:"How much the effect cares about being centered or not",control:"slider","default":0,min:0,max:2},{key:"edgeDampen",name:"Edge Dampening",type:"float",description:"Intensity adjustment by distance from center",control:"slider","default":.2,min:0,max:1},{key:"edgeScaling",name:"Edge Scaling",type:"float",description:"Scale adjustment by distance from center",control:"slider","default":0,min:-2,max:2},{key:"color",name:"Color",type:"vec3",description:"Effect Color",control:"color","default":[.8,.75,.7]},{key:"highRes",name:"High Resolution",type:"boolean",description:"Intensity of Effect",control:"checkbox","default":!1}]},a.prototype.updateFrameGeometry=function(e,t){this.camRot=t.transformComponent.transform.rotation,this.centerVector.set(t.cameraComponent.camera.translation),this.displacementVector.set(e.transformComponent.worldTransform.translation),this.displacementVector.sub(this.centerVector),this.distance=this.displacementVector.length(),this.distanceVector.set(0,0,-this.distance),this.camRot.applyPost(this.distanceVector),this.centerVector.add(this.distanceVector),this.positionVector.set(this.centerVector),this.displacementVector.set(e.transformComponent.worldTransform.translation),this.displacementVector.sub(this.positionVector),this.offset=this.displacementVector.length();var o=this.positionVector.length();this.centerRatio=o?1-this.offset*this.edgeRelevance/this.positionVector.length():1-this.offset*this.edgeRelevance,this.centerRatio=Math.max(0,this.centerRatio)},s.prototype.updatePosition=function(e){this.flareVector.set(e.displacementVector),this.positionVector.set(e.positionVector),this.flareVector.mul(this.displace),this.positionVector.add(this.flareVector),this.material.uniforms.materialEmissive=[this.color[0]*e.centerRatio*this.edgeDampen,this.color[1]*e.centerRatio*this.edgeDampen,this.color[2]*e.centerRatio*this.edgeDampen,1];var t=e.distance+e.distance*e.centerRatio*this.edgeScaling,o=this.quad.transformComponent.transform;o.scale.set(this.sizeVector),o.scale.mul(t),o.rotation.set(e.camRot),o.translation.set(this.positionVector),this.quad.transformComponent.updateTransform(),this.quad.transformComponent.updateWorldTransform()},r}(goo.Vector3,goo.ParticleSystemUtils,goo.Material,goo.ShaderLib,goo.Quad),goo.PanCamScript=function(e,t,o,n,i,r){"use strict";function a(){function t(e){var t=e[0].clientX,o=e[0].clientY,n=e[1].clientX,i=e[1].clientY,r=(t+n)/2,a=(o+i)/2;return[r,a]}function o(o,n){m=["Any","Left","Middle","Right"].indexOf(o.panButton)-1,-1>m&&(m=-1),f=n.goingToLookAt,c=new e(e.UNIT_Y),d=new e(e.UNIT_X).invert(),l=new e,u=new e,p=new e;var i=n.world.gooRunner.renderer;n.devicePixelRatio=i._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/i.svg.currentScale:1,h={x:0,y:0,ox:0,oy:0,dx:0,dy:0,down:!1},y={mousedown:function(e){if(!o.whenUsed||n.entity===n.activeCameraEntity){var t=e.button;if(0===t&&(e.altKey?t=2:e.shiftKey&&(t=1)),t===m||-1===m){h.down=!0;var i=void 0!==e.offsetX?e.offsetX:e.layerX,r=void 0!==e.offsetY?e.offsetY:e.layerY;h.ox=h.x=i,h.oy=h.y=r}}},mouseup:function(e){var t=e.button;0===t&&(e.altKey?t=2:e.shiftKey&&(t=1)),h.down=!1,h.dx=h.dy=0},mousemove:function(e){if((!o.whenUsed||n.entity===n.activeCameraEntity)&&h.down){var t=void 0!==e.offsetX?e.offsetX:e.layerX,i=void 0!==e.offsetY?e.offsetY:e.layerY;h.x=t,h.y=i,n.dirty=!0}},mouseleave:function(){h.down=!1,h.ox=h.x,h.oy=h.y},touchstart:function(e){if(!o.whenUsed||n.entity===n.activeCameraEntity){if(h.down=2===e.targetTouches.length,!h.down)return;var i=t(e.targetTouches);h.ox=h.x=i[0],h.oy=h.y=i[1]}},touchmove:function(e){if(!o.whenUsed||n.entity===n.activeCameraEntity){if(!h.down)return;var i=t(e.targetTouches);h.x=i[0],h.y=i[1]}},touchend:function(){h.down=!1,h.ox=h.x,h.oy=h.y}};for(var r in y)n.domElement.addEventListener(r,y[r]);n.dirty=!0}function a(e,t){
if(t.dirty){if(h.dx=h.x-h.ox,h.dy=h.y-h.oy,0===h.dx&&0===h.dy)return void(t.dirty=!!t.lookAtPoint);e.invertX&&(h.dx=-h.dx),e.invertY&&(h.dy=-h.dy),h.ox=h.x,h.oy=h.y;var o=n.mainCamera,a=t.entity,s=a.transformComponent.transform,l=a.cameraComponent.camera;if(f&&o){if(f.equals(o.translation))return;var m=t.viewportWidth/t.devicePixelRatio,y=t.viewportHeight/t.devicePixelRatio;o.getScreenCoordinates(f,m,y,u),u.subDirect(h.dx,h.dy,0),o.getWorldCoordinates(u.x,u.y,m,y,u.z,u),f.setVector(u)}else{if(u.setVector(c).scale(h.dy),p.setVector(d).scale(h.dx),a.cameraComponent&&a.cameraComponent.camera){var l=a.cameraComponent.camera;u.scale((l._frustumTop-l._frustumBottom)/t.viewportHeight),p.scale((l._frustumRight-l._frustumLeft)/t.viewportWidth)}u.addVector(p),s.rotation.applyPost(u),u.scale(l.projectionMode===r.Perspective?20*e.panSpeed:e.panSpeed),a.transformComponent.transform.translation.addVector(u),a.transformComponent.setUpdated(),t.dirty=!1}i.emit("goo.cameraPositionChanged",{translation:s.translation.data,lookAtPoint:f?f.data:null,id:a.id})}}function s(e,t){for(var o in y)t.domElement.removeEventListener(o,y[o])}var c,d,l,u,p,m,f,h,y;return{setup:o,update:a,cleanup:s}}return a.externals={key:"PanCamControlScript",name:"PanCamera Control",description:"Enables camera to pan around a point in 3D space using the mouse",parameters:[{key:"whenUsed",type:"boolean",name:"When Camera Used",description:"Script only runs when the camera to which it is added is being used.","default":!0},{key:"panButton",name:"Pan button",description:"Only pan with this button",type:"string",control:"select","default":"Any",options:["Any","Left","Middle","Right"]},{key:"panSpeed",type:"float","default":1,scale:.01}]},a}(goo.Vector3,goo.Scripts,goo.ScriptUtils,goo.Renderer,goo.SystemBus,goo.Camera),goo.OrbitNPanControlScript=function(e,t,o,n){"use strict";function i(){function n(e,t,o){a.setup(e,t,o),s.setup(e,t,o)}function i(e,t,o){s.update(e,t,o),a.update(e,t,o)}function r(e,t,o){s.cleanup(e,t,o),a.cleanup(e,t,o)}var a=e.create(t),s=e.create(o);return{setup:n,cleanup:r,update:i}}for(var r=t.externals.parameters,a=o.externals.parameters,s=n.deepClone(r.concat(a.slice(1))),c=0;c<s.length;c++){var d=s[c];if("panSpeed"===d.key){s.splice(c,1);break}}for(var c=0;c<s.length;c++){var d=s[c];switch(d.key){case"dragButton":d["default"]="Left";break;case"panButton":d["default"]="Right";break;case"panSpeed":d["default"]=1}}return i.externals={key:"OrbitNPanControlScript",name:"Orbit and Pan Control",description:"This is a combo of orbitcamcontrolscript and pancamcontrolscript",parameters:s},i}(goo.Scripts,goo.OrbitCamControlScript,goo.PanCamScript,goo.ObjectUtil),goo.PickAndRotateScript=function(){"use strict";function e(){function e(e){var t=e.button;return 0===t&&(e.altKey?t=2:e.shiftKey&&(t=1)),t}function t(t){if(!l.disable){var n=e(t.domEvent);n!==u.dragButton&&-1!==u.dragButton||!t.entity||(d=!1,t.entity.traverseUp(function(e){return e===u.entity?(d=!0,!1):void 0}),d&&o(t))}}function o(e){p.x=e.x,p.y=e.y,p.oldX=p.x,p.oldY=p.y,p.down=!0}function n(e){if(p.oldX=p.x,p.oldY=p.y,p.x=e.clientX||e.touches[0].clientX,p.y=e.clientY||e.touches[0].clientY,d&&p.down){var t=p.x-p.oldX,o=p.y-p.oldY;p.ax+=t,p.ay+=o,u.entity.transformComponent.transform.rotation.setIdentity(),u.entity.transformComponent.transform.rotation.rotateX(p.ay/300*l.yMultiplier),u.entity.transformComponent.transform.rotation.rotateY(p.ax/200*l.xMultiplier),u.entity.transformComponent.setUpdated()}}function i(e){p.down=!1}function r(e,o,r){l=e,u=o,u.dragButton=["Any","Left","Middle","Right"].indexOf(l.dragButton)-1,u.dragButton<-1&&(u.dragButton=-1),c=u.world.gooRunner,c.addEventListener("mousedown",t),c.addEventListener("touchstart",t),c.renderer.domElement.addEventListener("mousemove",n),c.renderer.domElement.addEventListener("touchmove",n),c.renderer.domElement.addEventListener("mouseup",i),c.renderer.domElement.addEventListener("touchend",i),p={down:!1,x:0,y:0,oldX:0,oldY:0,ax:0,ay:0}}function a(e,t,o){}function s(e,o,r){o.domElement.removeEventListener("mousemove",n),o.domElement.removeEventListener("touchmove",n),o.domElement.removeEventListener("mouseup",i),o.domElement.removeEventListener("touchend",i),c.removeEventListener("mousedown",t),c.removeEventListener("touchstart",t)}var c,d,l,u,p;return{setup:r,update:a,cleanup:s}}return e.externals={key:"PickAndRotateScript",name:"Pick and Rotate",description:"Enables pick-drag-rotating entities",parameters:[{key:"disable",description:"Prevent rotation. For preventing this script programmatically.",type:"boolean","default":!1},{key:"dragButton",description:"Button to enable dragging","default":"Any",options:["Any","Left","Middle","Right"],type:"string",control:"select"},{key:"xMultiplier",description:"Horizontal rotation multiplier","default":1,type:"float",control:"slider",min:-4,max:4},{key:"yMultiplier",description:"Vertical rotation multiplier","default":1,type:"float",control:"slider",min:-4,max:4}]},e}(),goo.PolyBoundingScript=function(){"use strict";function e(e){this.collidables=e||[]}return e.prototype.addCollidable=function(e){this.collidables.push(e)},e.prototype.removeAllAt=function(e,t,o){this.collidables=this.collidables.filter(function(n){return n.bottom<=o&&n.top>=o?!window.PolyK.ContainsPoint(n.poly,e,t):void 0})},e.prototype.inside=function(e,t,o){for(var n=0;n<this.collidables.length;n++){var i=this.collidables[n];if(i.bottom<=t&&i.top>=t&&window.PolyK.ContainsPoint(i.poly,e,o))return window.PolyK.ClosestEdge(i.poly,e,o)}},e.prototype.run=function(e){for(var t=e.transformComponent,o=t.transform.translation,n=0;n<this.collidables.length;n++){var i=this.collidables[n];if(i.bottom<=o.data[1]&&i.top>=o.data[1]&&window.PolyK.ContainsPoint(i.poly,o.data[0],o.data[2])){var r=window.PolyK.ClosestEdge(i.poly,o.data[0],o.data[2]);return o.data[0]=r.point.x,o.data[2]=r.point.y,void t.setUpdated()}}},e}(),goo.RotationScript=function(){"use strict";function e(){function e(e,t){i={x:0,y:0},r={x:0,y:0},a=t.entity,document.addEventListener("mousemove",o)}function t(e){r.x+=(i.x-r.x)*e.fraction,r.y+=(i.y-r.y)*e.fraction,a.setRotation(r.y/200,r.x/200,0)}function o(e){i.x=e.x,i.y=e.y}function n(){document.removeEventListener("mousemove",o)}var i,r,a;return{setup:e,update:t,cleanup:n}}return e.externals={key:"RotationScript",name:"Mouse Rotation",description:"",parameters:[{key:"fraction",name:"Speed","default":.01,type:"float",control:"slider",min:.01,max:1}]},e}(),goo.ScriptComponentHandler=function(e,t,o,n,i,r,a,s){"use strict";function c(){e.apply(this,arguments),this._type="ScriptComponent"}function d(e){var t=a.create(e);if(!t)throw new Error("Unrecognized script name");return t.id=c.ENGINE_SCRIPT_PREFIX+e,t.enabled=!1,r.emit("goo.scriptExternals",{id:t.id,externals:t.externals}),i.resolve(t)}return c.prototype=Object.create(e.prototype),c.prototype.constructor=c,e._registerClass("script",c),c.ENGINE_SCRIPT_PREFIX="GOO_ENGINE_SCRIPTS/",c.prototype._prepare=function(){},c.prototype._create=function(){return new t},c.prototype.update=function(t,i,r){var a=this;return e.prototype.update.call(this,t,i,r).then(function(e){if(e){var t=[];return n.forEach(i.scripts,function(e){var o=e.scriptRef,i=0===o.indexOf(c.ENGINE_SCRIPT_PREFIX),l=null;if(i){var u=o.slice(c.ENGINE_SCRIPT_PREFIX.length);l=d(u)}else l=a._load(e.scriptRef,{reload:!0});l=l.then(function(t){e.options=e.options||{},t.parameters&&n.defaults(e.options,t.parameters),t.externals&&t.externals.parameters&&s.fillDefaultValues(e.options,t.externals.parameters);var o=Object.create(t);return o.parameters={},o.enabled=!1,a._setParameters(o.parameters,e.options,t.externals,r).then(function(){return o})}),t.push(l)},null,"sortValue"),o.all(t).then(function(t){return e.scripts=t,e})}})},c.prototype._setParameters=function(e,t,n,r){if(!n||!n.parameters)return i.resolve();for(var a=[],s=0;s<n.parameters.length;s++){var c=n.parameters[s];this._setParameter(e,t[c.key],c,r)}return e.enabled=void 0!==t.enabled?t.enabled:!0,o.all(a)},c.prototype._setParameter=function(e,t,o,r){var a=o.key;return"texture"===o.type?t&&t.textureRef&&t.enabled!==!1?this._load(t.textureRef,r).then(function(t){e[a]=t}):(e[a]=null,i.resolve()):"entity"===o.type?t&&t.entityRef&&t.enabled!==!1?this._load(t.entityRef,r).then(function(t){e[a]=t}):(e[a]=null,i.resolve()):(e[a]=n.extend(t),i.resolve())},c}(goo.ComponentHandler,goo.ScriptComponent,goo.rsvp,goo.ObjectUtil,goo.PromiseUtil,goo.SystemBus,goo.Scripts,goo.ScriptUtils),goo.ScriptHandler=function(e,t,o,n,i,r,a,s,c,d,l,u,p){"use strict";function m(){e.apply(this,arguments),this._bodyCache={},this._dependencyPromises={},this._currentScriptLoading=null,this._addGlobalErrorListener()}function f(){for(var e=document.querySelectorAll("script"),t=0;t<e.length;++t){var o=e[t];o.isDependency&&!g(o)&&o.parentNode&&o.parentNode.removeChild(o)}}function h(e,t){if(!e.scriptRefs)return void(e.scriptRefs=[t]);var o=e.scriptRefs.indexOf(t);-1===o&&e.scriptRefs.push(t)}function y(e,t){e.scriptRefs&&d.remove(e.scriptRefs,t)}function g(e){return e.scriptRefs&&e.scriptRefs.length>0}function v(e,t){return e.scriptRefs&&e.scriptRefs.indexOf(t)>-1}function w(e){for(var t=[],o=document.querySelectorAll("script"),n=0;n<o.length;++n){var i=o[n];v(i,e)&&t.push(i)}return t}function S(e,t,o){return s.createPromise(function(n,i){function r(i){var r={message:i,file:o};b(e,r),t.parentNode&&t.parentNode.removeChild(t),n()}var a,s=!1;t.onload=function(){n(),a&&clearTimeout(a)},t.onerror=function(e){s=!0,a&&clearTimeout(a),console.error(e),r("Could not load dependency "+o)},s||(s=!0,a=setTimeout(function(){r("Loading dependency "+o+" failed (time out).")},k))})}function x(e,t){var o=e.errors||[];if("object"!=typeof e.externals)return void(t.externals={});var n=e.externals;if(!n.parameters||n.parameters instanceof Array||o.push("externals.parameters needs to be an array"),o.length)return void(t.errors=o);if(n.parameters){t.externals.parameters=[];for(var i=0;i<n.parameters.length;i++){var r=n.parameters[i];if("string"==typeof r.key&&0!==r.key.length)if(void 0===r.name||"string"==typeof r.name&&0!==r.name.length)if(-1!==C.indexOf(r.type))if(void 0===r.control||"string"==typeof r.control&&0!==r.control.length){var a=E[r.type];void 0===r.control||-1!==a.indexOf(r.control)?void 0===r.options||r.options instanceof Array?void 0===r.min||"number"==typeof r.min?void 0===r.max||"number"==typeof r.max?void 0===r.scale||"number"==typeof r.scale?void 0===r.decimals||"number"==typeof r.decimals?void 0===r.precision||"number"==typeof r.precision?void 0===r.exponential||"boolean"==typeof r.exponential?((null===r["default"]||void 0===r["default"])&&(r["default"]=u.defaultsByType[r.type]),t.externals.parameters.push(r)):o.push({message:'Parameter "exponential" needs to be a boolean.'}):o.push({message:'Parameter "precision" needs to be a number.'}):o.push({message:'Parameter "decimals" needs to be a number.'}):o.push({message:'Parameter "scale" needs to be a number.'}):o.push({message:'Parameter "max" needs to be a number.'}):o.push({message:'Parameter "min" needs to be a number.'}):o.push({message:'Parameter "key" needs to be array'}):o.push({message:'Parameter "control" needs to be one of: '+a.join(", ")+"."})}else o.push({message:'Parameter "control" needs to be a non-empty string.'});else o.push({message:'Parameter "type" needs to be one of: '+C.join(", ")+"."});else o.push({message:'Parameter "name" needs to be a non-empty string.'});else o.push({message:'Parameter "key" needs to be a non-empty string.'})}o.length&&(t.errors=o)}}function b(e,t){if(t.file){var o=t.message;t.line&&(o+=" - on line "+t.line),e.dependencyErrors=e.dependencyErrors||{},e.dependencyErrors[t.file]=t}else{e.errors=e.errors||[];var o=t.message;t.line&&(o+=" - on line "+t.line),e.errors.push(t),e.setup=null,e.update=null,e.run=null,e.cleanup=null,e.parameters={},e.enabled=!1}}var k=6e3;m.prototype=Object.create(e.prototype),m.prototype.constructor=m,e._registerClass("script",m),m.prototype._create=function(){return{externals:{},setup:null,update:null,run:null,cleanup:null,parameters:{},name:null}},m.prototype._remove=function(e){var t=this._objects.get(e);if(t&&t.cleanup&&t.context)try{t.cleanup(t.parameters,t.context,p.getClasses())}catch(o){}this._objects["delete"](e),delete this._bodyCache[e]},m.prototype._updateFromCustom=function(e,t){if(this._bodyCache[t.id]===t.body)return e;delete e.errors,this._bodyCache[t.id]=t.body;var o=document.getElementById(m.DOM_ID_PREFIX+t.id);o&&o.parentNode.removeChild(o),window._gooScriptFactories||(window._gooScriptFactories={});var n=["window._gooScriptFactories['"+t.id+"'] = function () {",t.body," var obj = {","  externals: {}"," };",' if (typeof parameters !== "undefined") {',"  obj.externals.parameters = parameters;"," }",' if (typeof setup !== "undefined") {',"  obj.setup = setup;"," }",' if (typeof cleanup !== "undefined") {',"  obj.cleanup = cleanup;"," }",' if (typeof update !== "undefined") {',"  obj.update = update;"," }"," return obj;","};"].join("\n"),i=document.createElement("script");i.id=m.DOM_ID_PREFIX+t.id,i.innerHTML=n,i.async=!1,this._currentScriptLoading=t.id;var r=this.world.gooRunner.renderer.domElement.parentElement||document.body;r.appendChild(i);var a=window._gooScriptFactories[t.id];if(a){try{a=a(),e.id=t.id,x(a,e),e.setup=a.setup,e.update=a.update,e.cleanup=a.cleanup,e.parameters={},e.enabled=!1}catch(s){var c={message:s.toString()};if(s instanceof Error){var d=s.stack.split("\n")[1].match(/(\d+):\d+\)$/);d&&(c.line=parseInt(d[1],10)-1)}b(e,c)}this._currentScriptLoading=null}return e.externals&&u.fillDefaultNames(e.externals.parameters),e},m.prototype._updateFromClass=function(e,t){if(!e.externals||e.externals.name!==t.className){var o=p.create(t.className);if(!o)throw new Error("Unrecognized script name");e.id=t.id,e.externals=o.externals,e.setup=o.setup,e.update=o.update,e.run=o.run,e.cleanup=o.cleanup,e.parameters=o.parameters||{},e.enabled=!1,u.fillDefaultNames(e.externals.parameters)}return e},m.prototype._update=function(o,n,i){var r=this;return e.prototype._update.call(this,o,n,i).then(function(e){if(e){var a=[];if(n.body&&n.dependencies){delete e.dependencyErrors;var s=w(n.id);c.forEach(n.dependencies,function(t){var o=t.url,i=d.find(s,function(e){return e.src===o});i&&d.remove(s,i),a.push(r._addDependency(e,o,n.id))},null,"sortValue"),c.forEach(s,function(e){y(e,n.id)})}return t.all(a).then(function(){return n.className?r._updateFromClass(e,n,i):n.body&&r._updateFromCustom(e,n,i),n.body&&l.emit("goo.scriptExternals",{id:n.id,externals:e.externals}),e.name=n.name,e.errors||e.dependencyErrors?(l.emit("goo.scriptError",{id:o,errors:e.errors,dependencyErrors:e.dependencyErrors}),e):(l.emit("goo.scriptError",{id:o,errors:null}),c.extend(e.parameters,n.options),f(),e)})}})},m.prototype._addDependency=function(e,t,o){var n=this,i=document.querySelector('script[src="'+t+'"]');if(i)return h(i,o),this._dependencyPromises[t]||s.resolve();i=document.createElement("script"),i.src=t,i.setAttribute("data-script-id",o),i.isDependency=!0,h(i,o);var r=this.world.gooRunner.renderer.domElement.parentElement||document.body;r.appendChild(i);var a=this._dependencyPromises[t]=S(e,i,t).then(function(){delete n._dependencyPromises[t]});return a},m.prototype._addGlobalErrorListener=function(){var e=this;window.addEventListener("error",function(t){if(t.filename){var o=document.querySelector('script[src="'+t.filename+'"]');if(o){var n=o.getAttribute("data-script-id"),i=e._objects.get(n);if(i){var r={message:t.message,line:t.lineno,file:t.filename};b(i,r)}o.parentNode.removeChild(o)}}if(e._currentScriptLoading){var a=document.getElementById(m.DOM_ID_PREFIX+e._currentScriptLoading);a&&a.parentNode.removeChild(a),delete window._gooScriptFactories[e._currentScriptLoading];var i=e._objects.get(e._currentScriptLoading),r={message:t.message,line:t.lineno-1};b(i,r),e._currentScriptLoading=null}})};var C=["string","int","float","vec2","vec3","vec4","boolean","texture","image","sound","camera","entity","animation"],E={string:["key"],"int":["spinner","slider","jointSelector"],"float":["spinner","slider"],vec2:[],vec3:["color"],vec4:["color"],"boolean":["checkbox"],texture:[],image:[],sound:[],camera:[],entity:[],animation:[]};for(var R in E)Array.prototype.push.apply(E[R],["dropdown","select"]);return m.DOM_ID_PREFIX="_script_",m}(goo.ConfigHandler,goo.rsvp,goo.OrbitCamControlScript,goo.OrbitNPanControlScript,goo.FlyControlScript,goo.WASDControlScript,goo.BasicControlScript,goo.PromiseUtil,goo.ObjectUtil,goo.ArrayUtil,goo.SystemBus,goo.ScriptUtils,goo.Scripts),goo.ScriptHandlers=function(){}(goo.ScriptHandler,goo.ScriptComponentHandler),goo.ScriptRegister=function(e){"use strict";for(var t=1;t<arguments.length;t++)e.register(arguments[t]),e.addClass(arguments[t].name,arguments[t])}(goo.Scripts,goo.OrbitCamControlScript,goo.OrbitNPanControlScript,goo.FlyControlScript,goo.AxisAlignedCamControlScript,goo.PanCamScript,goo.MouseLookControlScript,goo.WASDControlScript,goo.ButtonScript,goo.PickAndRotateScript,goo.LensFlareScript),goo.SparseHeightMapBoundingScript=function(){"use strict";function e(e){this.elevationData=e}return e.prototype.getClosest=function(e,t){for(var o=Number.MAX_VALUE,n=-1,i=0;i<this.elevationData.length;i+=3){var r=Math.pow(this.elevationData[i+0]-e,2)+Math.pow(this.elevationData[i+2]-t,2);o>r&&(o=r,n=i)}return this.elevationData[n+1]},e.prototype.run=function(e){var t=e.transformComponent.transform.translation,o=this.getClosest(t.data[0],t.data[2]),n=t.data[1]-o;t.data[1]-=.1*n},e}(),goo.WorldFittedTerrainScript=function(e,t){"use strict";function o(e,t){if(e.minX>e.maxX)throw{name:"Terrain Exception",message:"minX is larger than maxX"};if(e.minY>e.maxY)throw{name:"Terrain Exception",message:"minY is larger than maxY"};if(e.minZ>e.maxZ)throw{name:"Terrain Exception",message:"minZ is larger than maxZ"};if(!t)throw{name:"Terrain Exception",message:"No heightmap data specified"};if(t.length!==t[0].length)throw{name:"Terrain Exception",message:"Heightmap data is not a square"};return!0}function n(t,n,i){n=n||s,o(n,t,i);var r={dimensions:n,sideQuadCount:t.length-1,script:new e(t)};return r}function i(){this.heightMapData=[],this.yMargin=1}var r=new t,a=new t,s={minX:0,maxX:100,minY:0,maxY:50,minZ:0,maxZ:100};return i.prototype.addHeightData=function(e,t){var o=n(e,t,this.heightMapData);return this.heightMapData.push(o),o},i.prototype.getHeightDataForPosition=function(e){for(var t=0;t<this.heightMapData.length;t++){var o=this.heightMapData[t].dimensions;if(e[0]<=o.maxX&&e[0]>=o.minX&&e[1]<o.maxY+this.yMargin&&e[1]>o.minY-this.yMargin&&e[2]<=o.maxZ&&e[2]>=o.minZ)return this.heightMapData[t]}return null},i.prototype.displaceAxisDimensions=function(e,t,o,n){var i=e-t;return n*i/(o-t)},i.prototype.returnToWorldDimensions=function(e,t,o,n){var i=(o-t)/n,r=e*i;return t+r},i.prototype.getTerrainHeightAt=function(e){var t=this.getHeightDataForPosition(e);if(null===t)return null;var o=t.dimensions,n=this.displaceAxisDimensions(e[0],o.minX,o.maxX,t.sideQuadCount),i=this.displaceAxisDimensions(e[2],o.minZ,o.maxZ,t.sideQuadCount),r=t.script.getPreciseHeight(n,i);return r*(o.maxY-o.minY)+o.minY},i.prototype.getTerrainNormalAt=function(e){var t=this.getHeightDataForPosition(e);if(!t)return null;for(var o=t.dimensions,n=this.displaceAxisDimensions(e[0],o.minX,o.maxX,t.sideQuadCount),i=this.displaceAxisDimensions(e[2],o.minZ,o.maxZ,t.sideQuadCount),s=t.script.getTriangleAt(n,i),c=0;c<s.length;c++)s[c].x=this.returnToWorldDimensions(s[c].x,o.minX,o.maxX,t.sideQuadCount),s[c].z=this.returnToWorldDimensions(s[c].z,o.minY,o.maxY,1),s[c].y=this.returnToWorldDimensions(s[c].y,o.minZ,o.maxZ,t.sideQuadCount);return r.set(s[1].x-s[0].x,s[1].z-s[0].z,s[1].y-s[0].y),a.set(s[2].x-s[0].x,s[2].z-s[0].z,s[2].y-s[0].y),r.cross(a),r.data[1]<0&&r.scale(-1),r.normalize(),r},i}(goo.HeightMapBoundingScript,goo.Vector3),"function"==typeof require&&(define("goo/scriptpack/AxisAlignedCamControlScript",[],function(){return goo.AxisAlignedCamControlScript}),define("goo/scriptpack/BasicControlScript",[],function(){return goo.BasicControlScript}),define("goo/scriptpack/ButtonScript",[],function(){return goo.ButtonScript}),define("goo/scriptpack/CannonPickScript",[],function(){return goo.CannonPickScript}),define("goo/scriptpack/WASDControlScript",[],function(){return goo.WASDControlScript}),define("goo/scriptpack/MouseLookControlScript",[],function(){return goo.MouseLookControlScript}),define("goo/scriptpack/FlyControlScript",[],function(){return goo.FlyControlScript}),define("goo/scriptpack/GroundBoundMovementScript",[],function(){return goo.GroundBoundMovementScript}),define("goo/scriptpack/HeightMapBoundingScript",[],function(){return goo.HeightMapBoundingScript}),define("goo/scriptpack/LensFlareScript",[],function(){return goo.LensFlareScript}),define("goo/scriptpack/PanCamScript",[],function(){return goo.PanCamScript}),define("goo/scriptpack/OrbitNPanControlScript",[],function(){return goo.OrbitNPanControlScript}),define("goo/scriptpack/PickAndRotateScript",[],function(){return goo.PickAndRotateScript}),define("goo/scriptpack/PolyBoundingScript",[],function(){return goo.PolyBoundingScript}),define("goo/scriptpack/RotationScript",[],function(){return goo.RotationScript}),define("goo/scriptpack/ScriptComponentHandler",[],function(){return goo.ScriptComponentHandler}),define("goo/scriptpack/ScriptHandler",[],function(){return goo.ScriptHandler}),define("goo/scriptpack/ScriptHandlers",[],function(){return goo.ScriptHandlers}),define("goo/scriptpack/ScriptRegister",[],function(){return goo.ScriptRegister}),define("goo/scriptpack/SparseHeightMapBoundingScript",[],function(){return goo.SparseHeightMapBoundingScript}),define("goo/scriptpack/WorldFittedTerrainScript",[],function(){return goo.WorldFittedTerrainScript}));