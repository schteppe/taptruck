goo.PhysicsMaterial=function(){"use strict";function t(t){t=t||{},this.friction=void 0!==t.friction?t.friction:.3,this.restitution=void 0!==t.restitution?t.restitution:0}return t}(),goo.Collider=function(){"use strict";function t(){}return t.prototype.clone=function(){return new t},t.prototype.transform=function(){},t}(),goo.BoxCollider=function(t,o){"use strict";function e(e){e=e||{},this.halfExtents=e.halfExtents?new t(e.halfExtents):new t(.5,.5,.5),o.call(this)}return e.prototype=Object.create(o.prototype),e.prototype.constructor=e,e.prototype.transform=function(t,o){o.halfExtents.setVector(t.scale).mulVector(this.halfExtents)},e.prototype.clone=function(){return new e({halfExtents:this.halfExtents})},e}(goo.Vector3,goo.Collider),goo.CylinderCollider=function(t){"use strict";function o(o){o=o||{},this.radius=void 0!==o.radius?o.radius:.5,this.height=void 0!==o.height?o.height:1,t.call(this)}return o.prototype=Object.create(t.prototype),o.prototype.constructor=o,o.prototype.transform=function(t,o){var e=t.scale;o.radius=Math.max(e[0],e[1])*this.radius,o.height=e[2]*this.height},o.prototype.clone=function(){return new o({radius:this.radius,height:this.height})},o}(goo.Collider),goo.MeshCollider=function(t,o){"use strict";function e(e){e=e||{},this.meshData=e.meshData,this.scale=void 0!==e.scale?new o(e.scale):new o(1,1,1),t.call(this)}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.transform=function(t,o){o.scale.setVector(this.scale).mulVector(t.scale)},e.prototype.clone=function(){return new e({meshData:this.meshData,scale:this.scale})},e}(goo.Collider,goo.Vector3),goo.PlaneCollider=function(t){"use strict";function o(){t.call(this)}return o.prototype=Object.create(t.prototype),o.prototype.constructor=o,o.prototype.transform=function(){},o.prototype.clone=function(){return new o},o}(goo.Collider),goo.SphereCollider=function(t){"use strict";function o(o){o=o||{},this.radius=void 0!==o.radius?o.radius:.5,t.call(this)}return o.prototype=Object.create(t.prototype),o.prototype.constructor=o,o.prototype.transform=function(t,o){var e=t.scale.data;o.radius=this.radius*Math.max(Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2]))},o.prototype.clone=function(){return new o({radius:this.radius})},o}(goo.Collider),goo.PhysicsJoint=function(){"use strict";function t(t){t=t||{},this.connectedEntity=t.connectedEntity||null,this.collideConnected=void 0!==t.collideConnected?t.collideConnected:!1,this._dirty=!0}return t}(),goo.BallJoint=function(t,o){"use strict";function e(e){e=e||{},t.call(this,e),this.localPivot=e.localPivot?new o(e.localPivot):new o(0,.5,0),this.autoConfigureConnectedPivot=e.autoConfigureConnectedPivot?e.autoConfigureConnectedPivot:!0,this.connectedLocalPivot=e.connectedLocalPivot?new o(e.connectedLocalPivot):new o(0,.5,0)}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e}(goo.PhysicsJoint,goo.Vector3),goo.HingeJoint=function(t,o){"use strict";function e(e){e=e||{},t.call(this,e),this.localPivot=e.localPivot?new o(e.localPivot):new o(0,.5,0),this.autoConfigureConnectedPivot=e.autoConfigureConnectedPivot?e.autoConfigureConnectedPivot:!0,this.connectedLocalPivot=e.connectedLocalPivot?new o(e.connectedLocalPivot):new o,this.localAxis=e.localAxis?new o(e.localAxis):new o(1,0,0)}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e}(goo.PhysicsJoint,goo.Vector3),goo.AbstractPhysicsSystem=function(t,o){"use strict";function e(){t.apply(this,arguments),this.priority=-1,this._activeColliderEntities=[],this._colliderInsertedListener=function(t){this._activeColliderEntities.push(t.entity),this._colliderInserted(t.entity)}.bind(this),this._colliderDeletedListener=function(t){var o=this._activeColliderEntities,e=o.indexOf(t.entity);-1!==e&&this._activeColliderEntities.splice(e,1),this._colliderDeleted(t.entity)}.bind(this),this._colliderDeletedComponentListener=function(t){this._colliderDeletedComponent(t.entity,t.component)}.bind(this),o.addListener("goo.collider.inserted",this._colliderInsertedListener),o.addListener("goo.collider.deleted",this._colliderDeletedListener),o.addListener("goo.collider.deletedComponent",this._colliderDeletedComponentListener)}e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.setGravity=function(){};var n={entityA:null,entityB:null};return e.prototype.emitSubStepEvent=function(){o.emit("goo.physics.substep")},e.prototype.emitBeginContact=function(t,o){this._emitEvent("goo.physics.beginContact",t,o)},e.prototype.emitDuringContact=function(t,o){this._emitEvent("goo.physics.duringContact",t,o)},e.prototype.emitEndContact=function(t,o){this._emitEvent("goo.physics.endContact",t,o)},e.prototype._emitEvent=function(t,e,i){n.entityA=e,n.entityB=i,o.emit(t,n),n.entityA=null,n.entityB=null},e.prototype._colliderInserted=function(){},e.prototype._colliderDeleted=function(){},e}(goo.System,goo.SystemBus),goo.PhysicsPlaneDebugShape=function(t){"use strict";function o(){var o=t.defaultMap([t.POSITION]);t.call(this,o,10,14),this.indexModes[0]="Lines",this.rebuild()}return o.prototype=Object.create(t.prototype),o.prototype.constructor=o,o.prototype.buildWireframeData=function(){return new o},o.prototype.rebuild=function(){var o=[],e=[];return o.push(-1,-1,0,1,-1,0,1,1,0,-1,1,0,-2,0,0,2,0,0,0,-2,0,0,2,0,0,0,0,0,0,1),e.push(0,1,1,2,2,3,3,0,4,5,6,7,8,9),this.getAttributeBuffer(t.POSITION).set(o),this.getIndexBuffer().set(e),this},o}(goo.MeshData),goo.Pool=function(){"use strict";function t(t){t=t||{},this._objects=[],this._init=t.init||function(){},this._create=t.create||function(){},this._destroy=t.destroy||function(){}}return t.prototype.resize=function(t){for(var o=this._objects;o.length>t;)this._destroy(o.pop());for(;o.length<t;)o.push(this._create());return this},t.prototype.get=function(){var t=this._objects,o=t.length?t.pop():this._create();return this._init.apply(o,arguments),o},t.prototype.release=function(t){return this._destroy(t),this._objects.push(t),this},t}(),goo.PhysicsDebugRenderSystem=function(t,o,e,n,i,r,s,a,l,c,d,p,y,h,u,g,m,f){"use strict";function C(){o.call(this,"PhysicsDebugRenderSystem",["TransformComponent"]),this.priority=3,this.renderList=[],this.camera=null,e.addListener("goo.setCurrentCamera",function(t){this.camera=t.camera}.bind(this)),this.renderAll=!0,this.selection=new t,this.sphereMeshData=new n(8,8,1),this.boxMeshData=new i(1,1,1),this.cylinderMeshData=new r(10,1,1,1),this.planeMeshData=new s,this.material=new g(m.simpleColored),this.material.uniforms.color=[0,1,0],this.material.wireframe=!0,this.renderablePool=new f({create:function(){return{meshData:null,transform:new u,materials:[]}},init:function(t,o){this.meshData=t,this.materials[0]=o},destroy:function(t){t.meshData=null,t.materials.length=0}})}return C.prototype=Object.create(o.prototype),C.prototype.constructor=C,C.prototype.process=function(t){if(this.clear(),!this.passive)for(var o=0,e=t.length;o!==e;o++){var n=t[o];if((this.renderAll||this.selection.contains(n))&&n.colliderComponent){var i=n.colliderComponent.worldCollider,r=this.getMeshData(i),s=this.renderablePool.get(r,this.material);this.getWorldTransform(n,i,s.transform),s.transform.update(),this.renderList.push(s)}}},C.prototype.getWorldTransform=function(t,o,e){if(e.copy(t.transformComponent.worldTransform),o instanceof a){var n=o.radius;e.scale.set(n,n,n)}else o instanceof l?e.scale.copy(o.halfExtents).mul(2):o instanceof c?e.scale.set(o.radius,o.radius,o.height):o instanceof d?e.scale.set(1,1,1):o instanceof p&&e.scale.setVector(o.scale)},C.prototype.getMeshData=function(t){var o;return t instanceof a?o=this.sphereMeshData:t instanceof l?o=this.boxMeshData:t instanceof c?o=this.cylinderMeshData:t instanceof d?o=this.planeMeshData:t instanceof p&&(o=t.meshData),o},C.prototype.render=function(t){t.checkResize(this.camera),this.camera&&t.render(this.renderList,this.camera,null,null,!1)},C.prototype.clear=function(){for(var t=0,o=this.renderList.length;t!==o;t++)this.renderablePool.release(this.renderList[t]);this.renderList.length=0},C.prototype.cleanup=function(){this.clear()},C}(goo.EntitySelection,goo.System,goo.SystemBus,goo.Sphere,goo.Box,goo.Cylinder,goo.PhysicsPlaneDebugShape,goo.SphereCollider,goo.BoxCollider,goo.CylinderCollider,goo.PlaneCollider,goo.MeshCollider,goo.Quaternion,goo.Vector3,goo.Transform,goo.Material,goo.ShaderLib,goo.Pool),goo.AbstractRigidBodyComponent=function(t,o,e,n,i){"use strict";function r(){t.call(this,arguments),this.joints=[],this._dirty=!0}var s=new e;r.prototype=Object.create(t.prototype),r.prototype.constructor=r,r.prototype.addJoint=function(t){this.joints.push(t)},r.prototype.removeJoint=function(t){var o=this.joints,e=o.indexOf(t);-1!==e&&(o.splice(e,1),this.destroyJoint(t))},r.initializedEvent={entity:null},r.prototype.emitInitialized=function(t){var o=r.initializedEvent;o.entity=t,i.emit("goo.physics.initialized",o),o.entity=null},r.prototype.initialize=function(){},r.prototype.destroy=function(){},r.prototype.initializeJoint=function(){},r.prototype.destroyJoint=function(){};var a=new n,l=new n,c=new n;return r.prototype.traverseColliders=function(t,o){t.transformComponent.updateTransform(),t.transformComponent.updateWorldTransform();var e=t.transformComponent.worldTransform;a.copy(e),a.invert(a);for(var i=[t];i.length;){var r=i.pop(),d=r.colliderComponent;if(d){r.transformComponent.updateTransform(),r.transformComponent.updateWorldTransform(),l.copy(r.transformComponent.worldTransform),n.combine(a,l,c);var p=c.translation,y=c.rotation;s.fromRotationMatrix(y),o.call(this,r,d.collider,p,s)}for(var h=r.transformComponent.children,u=0;u<h.length;u++){var g=h[u].entity;g.rigidBodyComponent||i.push(g)}}},r.prototype.attached=function(){},r.prototype.detached=function(){for(var t=this.joints,o=t.length,e=0;e!==o;e++)this.destroyJoint(t[e]);t.length=0,this.destroy(),this._entity=null,this._system=null},r}(goo.Component,goo.Vector3,goo.Quaternion,goo.Transform,goo.SystemBus),goo.ColliderComponent=function(t,o){"use strict";function e(o){t.apply(this),this.type="ColliderComponent",o=o||{},this.entity=null,this._updated=!1,this._dirty=!0,this.collider=o.collider||null,this.worldCollider=this.collider?this.collider.clone():null,this.isTrigger=void 0!==o.isTrigger?o.isTrigger:!1,this.bodyEntity=null,this.material=void 0!==o.material?o.material:null}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.type="ColliderComponent",e.prototype.getBodyEntity=function(){var t;return this.entity.traverseUp(function(o){return o.rigidBodyComponent?(t=o,!1):void 0}),t},e.prototype.updateWorldCollider=function(t){var o=!1;if(t){var e=[];this.entity.traverseUp(function(t){e.unshift(t)});for(var n=e.length,i=0;i!==n;i++){var r=e[i],s=r.transformComponent;(s._dirty||o)&&(s.updateTransform(),s.updateWorldTransform(),o=!0)}}(o||this._dirty)&&(this.collider.transform(this.entity.transformComponent.worldTransform,this.worldCollider),this._updated=!0)},e.prototype.attached=function(t){this.entity=t},e.prototype.detached=function(){this.entity=null},e.prototype.setToDirty=function(){this._dirty=!0},e.prototype.setToClean=function(){this._dirty=!1},e.prototype.isDirty=function(){return this._dirty},e.applyOnEntity=function(t,n){return t instanceof o?(n.setComponent(new e({collider:t})),!0):void 0},e.prototype.api={},e}(goo.Component,goo.Collider),goo.ColliderSystem=function(t,o){"use strict";function e(){t.call(this,"ColliderSystem",["ColliderComponent","TransformComponent"]),this.priority=1}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.process=function(t){for(var o=t.length,e=0;e!==o;e++){var n=t[e],i=n.transformComponent,r=n.colliderComponent;r._updated=!1,i._updated&&(n.colliderComponent.updateWorldCollider(),n.colliderComponent.setToDirty())}},e.prototype.inserted=function(t){o.emit("goo.collider.inserted",{entity:t})},e.prototype.deleted=function(t){o.emit("goo.collider.deleted",{entity:t})},e.prototype.removedComponent=function(t,e){o.emit("goo.collider.deletedComponent",{entity:t,component:e})},e}(goo.System,goo.SystemBus),goo.RaycastResult=function(t){"use strict";function o(o){o=o||{},this.point=o.point?new t(o.point):new t,this.normal=o.normal?new t(o.normal):new t,this.entity=o.entity||null}return o.prototype.reset=function(){this.entity=null},o}(goo.Vector3),goo.RigidBodyComponent=function(t,o,e,n,i,r,s,a,l,c,d){"use strict";function p(e){e=e||{},t.apply(this,arguments),this.type="RigidBodyComponent",this.cannonBody=null,this._dirty=!0,this._isKinematic=!!e.isKinematic,this._mass=void 0!==e.mass?e.mass:1,this._isKinematic?this._mass=0:0===this._mass&&(this._isKinematic=!0),this._initialized=!1,this._velocity=e.velocity?new o(e.velocity):new o,this._angularVelocity=e.angularVelocity?new o(e.angularVelocity):new o,this._linearDamping=void 0!==e.linearDamping?e.linearDamping:.01,this._angularDamping=void 0!==e.angularDamping?e.angularDamping:.05,this._sleepingThreshold=void 0!==e.sleepingThreshold?e.sleepingThreshold:.2,this._sleepingTimeLimit=void 0!==e.sleepingTimeLimit?e.sleepingTimeLimit:1,y||(y=new CANNON.Vec3,h=new CANNON.Vec3),this._colliderEntities=[]}var y,h,u=new e;return p.prototype=Object.create(t.prototype),p.prototype.constructor=p,p.type="RigidBodyComponent",p.numCylinderSegments=10,p.prototype.setTransformFromEntity=function(t){var o=t.transformComponent.worldTransform,e=this.cannonBody;e.position.copy(o.translation),u.fromRotationMatrix(o.rotation),e.quaternion.copy(u)},p.prototype.applyForce=function(t){y.copy(t),this.cannonBody.force.vadd(y,this.cannonBody.force)},p.prototype.setVelocity=function(t){this.cannonBody&&this.cannonBody.velocity.copy(t),this._velocity.setVector(t)},p.prototype.getVelocity=function(t){var o=this.cannonBody,e=o?o.velocity:this._velocity;t.setDirect(e.x,e.y,e.z)},p.prototype.setAngularVelocity=function(t){this.cannonBody&&this.cannonBody.angularVelocity.copy(t),this._angularVelocity.setVector(t)},p.prototype.getAngularVelocity=function(t){var o=this.cannonBody,e=o?o.angularVelocity:this._angularVelocity;t.setDirect(e.x,e.y,e.z)},p.prototype.setPosition=function(t){this.cannonBody&&this.cannonBody.position.copy(t)},p.prototype.getPosition=function(t){var o=this.cannonBody.position;t.setDirect(o.x,o.y,o.z)},p.prototype.setQuaternion=function(t){this.cannonBody&&this.cannonBody.quaternion.copy(t)},p.prototype.getQuaternion=function(t){if(this.cannonBody){var o=this.cannonBody.quaternion;t.setDirect(o.x,o.y,o.z,o.w)}},Object.defineProperties(p.prototype,{linearDamping:{get:function(){return this._linearDamping},set:function(t){this.cannonBody&&(this.cannonBody.linearDamping=t),this._linearDamping=t}},angularDamping:{get:function(){return this._angularDamping},set:function(t){this.cannonBody&&(this.cannonBody.angularDamping=t),this._angularDamping=t}},isKinematic:{get:function(){return this._isKinematic},set:function(t){this._isKinematic=t,this._dirty=!0}},sleepingThreshold:{get:function(){return this._sleepingThreshold},set:function(t){this._sleepingThreshold=t,this.cannonBody&&(this.cannonBody.sleepSpeedLimit=t)}},mass:{get:function(){return this._mass},set:function(t){this._mass=t,this.cannonBody&&(this.cannonBody.mass=t,this.cannonBody.updateMassProperties())}},sleepingTimeLimit:{get:function(){return this._sleepingTimeLimit},set:function(t){this._sleepingTimeLimit=t,this.cannonBody&&(this.cannonBody.sleepTimeLimit=t)}}}),p.getCannonShape=function(t){var e;if(t instanceof i){var n=new CANNON.Vec3;n.copy(t.halfExtents),e=new CANNON.Box(n)}else if(t instanceof r)e=new CANNON.Sphere(t.radius);else if(t instanceof a)e=new CANNON.Plane;else if(t instanceof s){e=new CANNON.Cylinder(t.radius,t.radius,t.height,p.numCylinderSegments);var c=new CANNON.Quaternion;c.setFromAxisAngle(new o(0,0,1),-Math.PI/2),e.transformAllPoints(new o,c),e.computeEdges(),e.updateBoundingSphereRadius()}else if(t instanceof l){if("Triangles"!==t.meshData.indexModes[0])throw new Error("MeshCollider data must be a triangle mesh!");e=new CANNON.Trimesh(t.meshData.getAttributeBuffer("POSITION"),t.meshData.getIndexBuffer())}else console.warn("Unhandled collider: ",t);return e},p.prototype.destroy=function(){var t=this.cannonBody;t&&(t.world.removeBody(t),delete this._system._entities[t.id],t.shapes.forEach(function(t){this._system._shapeIdToColliderEntityMap["delete"](t.id)}.bind(this)),this.cannonBody=null,this._dirty=!0);for(var o=0;o<this._colliderEntities.length;o++)this._colliderEntities[o].bodyEntity=null;this._colliderEntities.length=0},p.prototype.initialize=function(){if(this._dirty){this.destroy();var t=this.cannonBody=new CANNON.Body({mass:this._mass,linearDamping:this._linearDamping,angularDamping:this._angularDamping,sleepSpeedLimit:this._sleepingThreshold,sleepTimeLimit:this._sleepingTimeLimit});this._system.cannonWorld.addBody(t),this._system._entities[t.id]=this._entity,this._initialized||(t.velocity.copy(this._velocity),t.angularVelocity.copy(this._angularVelocity)),this.traverseColliders(this._entity,function(t,o,e,n){this.addCollider(t,e,n),t.colliderComponent.bodyEntity=this._entity}),this._isKinematic&&(t.type=CANNON.Body.KINEMATIC),this.setTransformFromEntity(this._entity),this._initialized=!0,this._dirty=!1,this.emitInitialized(this._entity)}},p.prototype.initializeJoint=function(t){var o,e=this.cannonBody,n=t.connectedEntity.rigidBodyComponent.cannonBody;if(t instanceof c){var i=t.localPivot.clone();i.mulVector(this._entity.transformComponent.transform.scale);var r=new CANNON.Vec3,s=new CANNON.Vec3;if(r.copy(i),t.autoConfigureConnectedPivot)e.pointToWorldFrame(r,s),n.pointToLocalFrame(s,s);else{var a=t.connectedLocalPivot.clone();a.mulVector(t.connectedEntity.transformComponent.transform.scale),s.copy(a)}o=new CANNON.PointToPointConstraint(e,r,n,s)}else if(t instanceof d){var r=new CANNON.Vec3,s=new CANNON.Vec3,l=new CANNON.Vec3,p=new CANNON.Vec3,i=t.localPivot.clone();if(i.mulVector(this._entity.transformComponent.transform.scale),r.copy(i),l.copy(t.localAxis),t.autoConfigureConnectedPivot)e.pointToWorldFrame(r,s),n.pointToLocalFrame(s,s);else{var a=t.connectedLocalPivot.clone();a.mulVector(t.connectedEntity.transformComponent.transform.scale),s.copy(a)}p.copy(t.localAxis),e.vectorToWorldFrame(t.localAxis,p),n.vectorToLocalFrame(p,p),o=new CANNON.HingeConstraint(e,n,{pivotA:r,pivotB:s,axisA:l,axisB:p,collideConnected:t.collideConnected})}else console.warn("Unhandled joint: ",t);o&&(e.world.addConstraint(o),t.cannonJoint=o)},p.copyScaleFromColliderToCannonShape=function(t,o){if(o instanceof r)t.radius=o.radius;else if(o instanceof i)t.halfExtents.copy(o.halfExtents),t.updateConvexPolyhedronRepresentation(),t.updateBoundingSphereRadius();else if(o instanceof l){var e;y||(y=new CANNON.Vec3),e=y,e.copy(o.scale),t.setScale(e)}t.updateBoundingSphereRadius()},p.prototype.updateDirtyColliders=function(){for(var t=this._colliderEntities,o=t.length-1;o>=0;o--){var e=t[o],n=e.colliderComponent.getBodyEntity();if(n!==this._entity)return t.splice(o,1),void e.colliderComponent.setToDirty();var i=e.colliderComponent;i.isDirty()&&(i.updateWorldCollider(),p.copyScaleFromColliderToCannonShape(i.cannonShape,i.worldCollider),i.cannonShape.collisionResponse=!i.isTrigger,i.setToClean())}},p.prototype.destroyJoint=function(t){var o=this.cannonBody;o&&t.cannonJoint&&(o.world.removeConstraint(t.cannonJoint),t.cannonJoint=null)},p.prototype.addCollider=function(t,o,e){var n=this.cannonBody,i=t.colliderComponent;i.updateWorldCollider(!0);var r=i.worldCollider,s=i.cannonShape=p.getCannonShape(r);this._system._shapeIdToColliderEntityMap.set(s.id,t);var a=new CANNON.Material;a.friction=i.material?i.material.friction:-1,a.restitution=i.material?i.material.restitution:-1,s.material=a,s.collisionResponse=!i.isTrigger;var l=new CANNON.Vec3;o&&l.copy(o);var c=new CANNON.Quaternion;o&&c.copy(e),n.addShape(s,l,c),this._colliderEntities.push(t)},p.prototype.clone=function(){return new p({isKinematic:this._isKinematic,mass:this._mass,velocity:this._velocity,angularVelocity:this._angularVelocity,linearDamping:this._linearDamping,angularDamping:this._angularDamping,sleepingThreshold:this._sleepingThreshold,sleepingTimeLimit:this._sleepingTimeLimit})},p.prototype.attached=function(t){this._entity=t,this._system=t._world.getSystem("PhysicsSystem")},p.prototype.setToDirty=function(){this._dirty=!0},p.prototype.setToClean=function(){this._dirty=!1},p.prototype.isDirty=function(){return this._dirty},p.prototype.api={},p}(goo.AbstractRigidBodyComponent,goo.Vector3,goo.Quaternion,goo.Transform,goo.BoxCollider,goo.SphereCollider,goo.CylinderCollider,goo.PlaneCollider,goo.MeshCollider,goo.BallJoint,goo.HingeJoint),goo.PhysicsSystem=function(t,o,e,n,i,r,s){"use strict";function a(o){o=o||{},this.cannonWorld=new CANNON.World({broadphase:new CANNON.SAPBroadphase});var e=this;this.cannonWorld.addEventListener("postStep",function(){e.emitContactEvents(),e.emitSubStepEvent()}),this._entities={},this._shapeIdToColliderEntityMap=new Map,l||(l=new CANNON.Vec3,c=new CANNON.Vec3,d=new CANNON.RaycastResult),this.setGravity(o.gravity||new n(0,-10,0)),this.stepFrequency=void 0!==o.stepFrequency?o.stepFrequency:60,this.maxSubSteps=void 0!==o.maxSubSteps?o.maxSubSteps:10,this._currentContacts=new Set,this._lastContacts=new Set,this._sortContacts=function(t,o){return a._getShapePairHash(t.si,t.sj)-a._getShapePairHash(o.si,o.sj)}.bind(this),this._emitEndContactEvents=function(t){var o=a._getShapeIdA(t),e=a._getShapeIdB(t),n=this._shapeIdToColliderEntityMap.get(o),i=this._shapeIdToColliderEntityMap.get(e),r=this._currentContacts.has(t);r||this.emitEndContact(n,i)}.bind(this),this._moveHashes=function(t){this._lastContacts.add(t),this._currentContacts["delete"](t)}.bind(this),this._emptyLastContacts=function(t){this._lastContacts["delete"](t)}.bind(this),t.call(this,"PhysicsSystem",["RigidBodyComponent"])}var l,c,d,p=new i,y=new n,h=new s;a.prototype=Object.create(t.prototype),a.prototype.constructor=a,a.prototype._swapContactLists=function(){this._lastContacts.forEach(this._emptyLastContacts),this._currentContacts.forEach(this._moveHashes)},a.prototype.setGravity=function(t){this.cannonWorld.gravity.copy(t)},a.prototype.step=function(t){var o=this.cannonWorld,e=1/this.stepFrequency,n=this.maxSubSteps;n?o.step(e,t,n):o.step(t)},a._getShapePairHash=function(t,o){var e=t.id,n=o.id;if(e>n){var i=e;e=n,n=i}var r=e<<16|n;return r},a._getShapeIdA=function(t){return(4294901760&t)>>16},a._getShapeIdB=function(t){return 65535&t},a.prototype._fillContactsMap=function(t,o){for(var e=0;e!==t.length;e++){var n=t[e],i=a._getShapePairHash(n.si,n.sj);o.add(i)}},a.prototype.emitContactEvents=function(){var t=this.cannonWorld.contacts.sort(this._sortContacts),o=this._currentContacts,e=this._lastContacts;this._fillContactsMap(t,o);for(var n,i=0;i<t.length;i++){var r=t[i],s=r.si,l=r.sj,c=this._shapeIdToColliderEntityMap.get(s.id),d=this._shapeIdToColliderEntityMap.get(l.id),p=a._getShapePairHash(r.si,r.sj);if(p!==n){var y=this._lastContacts.has(p);y?this.emitDuringContact(c,d):this.emitBeginContact(c,d)}n=p}e.forEach(this._emitEndContactEvents),this._swapContactLists()};var u={};a.prototype._getCannonRaycastOptions=function(t){return u.collisionFilterMask=void 0!==t.collisionMask?t.collisionMask:-1,u.collisionFilterGroup=void 0!==t.collisionGroup?t.collisionGroup:-1,u.skipBackfaces=void 0!==t.skipBackfaces?t.skipBackfaces:!0,u},a.prototype._copyCannonRaycastResultToGoo=function(t,o){if(t.hasHit){o.entity=this._entities[t.body.id];var e=t.hitPointWorld,n=t.hitNormalWorld;o.point.setDirect(e.x,e.y,e.z),o.normal.setDirect(n.x,n.y,n.z)}return t.hasHit},a.prototype._getCannonStartEnd=function(t,o,e,n,i){n.copy(t),i.copy(o),i.scale(e,i),i.vadd(t,i)},a.prototype.raycastAny=function(t,e,n,i,r){i instanceof o&&(r=i,i={}),i=i||{},r=r||new o;var s=l,a=c;return this._getCannonStartEnd(t,e,n,s,a),this.cannonWorld.raycastAny(s,a,this._getCannonRaycastOptions(i),d),this._copyCannonRaycastResultToGoo(d,r)},a.prototype.raycastClosest=function(t,e,n,i,r){i instanceof o&&(r=i,i={}),i=i||{},r=r||new o;var s=l,a=c;return this._getCannonStartEnd(t,e,n,s,a),this.cannonWorld.raycastClosest(s,a,this._getCannonRaycastOptions(i),d),this._copyCannonRaycastResultToGoo(d,r)};var g=new o;return a.prototype.raycastAll=function(t,o,e,n,i){"function"==typeof n&&(i=n,n={}),i=i||function(){};var r=l,s=c;this._getCannonStartEnd(t,o,e,r,s);var a=this,d=!1;return this.cannonWorld.raycastAll(r,s,this._getCannonRaycastOptions(n),function(t){var o=a._copyCannonRaycastResultToGoo(t,g);o&&(d=!0),i(g)===!1&&t.abort()}),d},a.prototype.pause=function(){this.passive=!0},a.prototype.play=function(){this.passive=!1,this.updateLonelyColliders(!0)},a.prototype.stop=function(){this.pause(),this.setAllBodiesDirty(),this.setAllCollidersDirty()},a.prototype.setAllBodiesDirty=function(){for(var t=0;t<this._activeEntities.length;t++)this._activeEntities[t].rigidBodyComponent.setToDirty()},a.prototype.setAllCollidersDirty=function(){for(var t=0;t<this._activeColliderEntities.length;t++)this._activeColliderEntities[t].colliderComponent.setToDirty()},a.prototype.inserted=function(t){t.rigidBodyComponent.initialize()},a.prototype.deleted=function(t){if(t.rigidBodyComponent){for(var o=0;o<t.rigidBodyComponent.joints.length;o++)t.rigidBodyComponent.destroyJoint(t.rigidBodyComponent.joints[o]);t.rigidBodyComponent.joints.length=0,t.rigidBodyComponent.destroy()}},a.prototype._addLonelyCollider=function(t){var o=null;t.colliderComponent.material&&(o=new CANNON.Material,o.friction=t.colliderComponent.material.friction,o.restitution=t.colliderComponent.material.restitution),t.colliderComponent.updateWorldCollider();var n=e.getCannonShape(t.colliderComponent.worldCollider);n.material=o;var i=new CANNON.Body({mass:0,collisionResponse:!t.colliderComponent.isTrigger,shape:n});this.cannonWorld.addBody(i),t.colliderComponent.cannonBody=i,t.colliderComponent.bodyEntity&&t.colliderComponent.bodyEntity.rigidBodyComponent&&t.colliderComponent.bodyEntity.rigidBodyComponent.setToDirty(),t.colliderComponent.bodyEntity=null,t.colliderComponent.setToDirty()},a.prototype._removeLonelyCollider=function(t){t.colliderComponent.cannonBody&&(this.cannonWorld.removeBody(t.colliderComponent.cannonBody),t.colliderComponent.cannonBody=null);var o=t.colliderComponent.getBodyEntity();o&&o.rigidBodyComponent.setToDirty(),t.colliderComponent.setToDirty()},a.prototype._colliderDeleted=function(t){var o=t.colliderComponent;if(o){var e=o.cannonBody;e&&(this.cannonWorld.removeBody(e),o.cannonBody=null)}},a.prototype._colliderDeletedComponent=function(t,o){var e=o.cannonBody;e&&(this.cannonWorld.removeBody(e),o.cannonBody=null)},a.prototype.initialize=function(t){for(var o=t.length,e=0;e!==o;e++){var n=t[e],i=n.rigidBodyComponent;i.isDirty()&&i.initialize(),i.updateDirtyColliders()}for(var e=0;e!==o;e++)for(var n=t[e],r=n.rigidBodyComponent.joints,s=0;s<r.length;s++){var a=r[s];a._dirty&&(n.rigidBodyComponent.initializeJoint(a,n,this),a._dirty=!1)}for(var e=0;e!==this._activeColliderEntities.length;e++){var l=this._activeColliderEntities[e];l.colliderComponent&&(l.colliderComponent.getBodyEntity()||l.colliderComponent.cannonBody&&!l.colliderComponent.isDirty()||(this._removeLonelyCollider(l),this._addLonelyCollider(l)),l.colliderComponent.getBodyEntity()&&l.colliderComponent.cannonBody&&this._removeLonelyCollider(l))}},a.prototype.process=function(t,o){this.initialize(t),this.updateLonelyColliders(),this.step(o),this.syncTransforms(t)},a.prototype.updateLonelyColliders=function(t){for(var o=this._activeColliderEntities.length-1;o>=0;o--){var n=this._activeColliderEntities[o],i=n.colliderComponent;if(i&&(t||i._dirty||n.transformComponent._updated)){var r=n.transformComponent.worldTransform,s=i.cannonBody;if(s){s.position.copy(r.translation),p.fromRotationMatrix(r.rotation),s.quaternion.copy(p);var a=s.shapes[0];a&&(a.collisionResponse=!i.isTrigger,i.updateWorldCollider(),e.copyScaleFromColliderToCannonShape(a,i.worldCollider))}}}},a.prototype.syncTransforms=function(t){for(var o=t.length,e=[],n=0;n!==o;n++){var i=t[n],r=i.rigidBodyComponent;r._updated=!1,i.transformComponent.parent?e.unshift(i):e.push(i)}for(;e.length;){var i=e.pop(),r=i.rigidBodyComponent,a=i.transformComponent,l=a.transform;if(!r._updated){r._updated=!0,r.getPosition(y),r.getQuaternion(p),l.translation.setVector(y),l.rotation.copyQuaternion(p),a.updateTransform(),a.updateWorldTransform();var c=a.parent;c&&(c.entity.transformComponent.worldTransform.invert(h),s.combine(h,l,h),l.rotation.copy(h.rotation),l.translation.copy(h.translation),a.updateTransform(),a.updateWorldTransform()),a.setUpdated()}}},a}(goo.AbstractPhysicsSystem,goo.RaycastResult,goo.RigidBodyComponent,goo.Vector3,goo.Quaternion,goo.EntityUtils,goo.Transform),goo.PhysicsRegister=function(t){"use strict";for(var o=["goo/scripts/Scripts","goo/addons/physicspack/colliders/BoxCollider","goo/addons/physicspack/colliders/Collider","goo/addons/physicspack/colliders/CylinderCollider","goo/addons/physicspack/colliders/MeshCollider","goo/addons/physicspack/colliders/PlaneCollider","goo/addons/physicspack/colliders/SphereCollider","goo/addons/physicspack/joints/BallJoint","goo/addons/physicspack/joints/HingeJoint","goo/addons/physicspack/joints/PhysicsJoint","goo/addons/physicspack/systems/AbstractPhysicsSystem","goo/addons/physicspack/systems/PhysicsDebugRenderSystem","goo/addons/physicspack/components/AbstractRigidBodyComponent","goo/addons/physicspack/components/ColliderComponent","goo/addons/physicspack/systems/ColliderSystem","goo/addons/physicspack/systems/PhysicsSystem","goo/addons/physicspack/RaycastResult","goo/addons/physicspack/PhysicsMaterial","goo/addons/physicspack/components/RigidBodyComponent","goo/addons/physicspack/shapes/PhysicsPlaneDebugShape"],e=1;e<o.length;e++){var n=o[e].slice(o[e].lastIndexOf("/")+1);t.addClass(n,arguments[e])}}(goo.Scripts,goo.BoxCollider,goo.Collider,goo.CylinderCollider,goo.MeshCollider,goo.PlaneCollider,goo.SphereCollider,goo.BallJoint,goo.HingeJoint,goo.PhysicsJoint,goo.AbstractPhysicsSystem,goo.PhysicsDebugRenderSystem,goo.AbstractRigidBodyComponent,goo.ColliderComponent,goo.ColliderSystem,goo.PhysicsSystem,goo.RaycastResult,goo.PhysicsMaterial,goo.RigidBodyComponent,goo.PhysicsPlaneDebugShape),goo.ColliderComponentHandler=function(t,o,e,n,i,r,s,a,l,c,d){"use strict";function p(){t.apply(this,arguments),this._type="ColliderComponent"}return p.prototype=Object.create(t.prototype),p.prototype.constructor=p,t._registerClass("collider",p),p.prototype._prepare=function(t){return r.defaults(t,{shape:"Box",shapeOptions:{halfExtents:[1,1,1],radius:.5,height:1},isTrigger:!1,friction:.3,restitution:0})},p.prototype._create=function(){return new o({material:new d})},p.prototype._remove=function(t){t.clearComponent("ColliderComponent")},p.prototype.update=function(o,e,n){return t.prototype.update.call(this,o,e,n).then(function(t){if(t){switch(e.shape){default:case"Box":t.collider=new a(e.shapeOptions),t.worldCollider=new a;break;case"Sphere":t.collider=new s(e.shapeOptions),t.worldCollider=new s;break;case"Plane":t.collider=new l,t.worldCollider=new l;break;case"Cylinder":t.collider=new c(e.shapeOptions),t.worldCollider=new c}return t.material.friction=e.friction,t.material.restitution=e.restitution,t.isTrigger=e.isTrigger,t.setToDirty(),o.traverseUp(function(t){t.rigidBodyComponent&&(t.rigidBodyComponent.initialize(),t.rigidBodyComponent.setToDirty())}),t}})},p}(goo.ComponentHandler,goo.ColliderComponent,goo.BoundingBox,goo.ShapeCreatorMemoized,goo.rsvp,goo.ObjectUtil,goo.SphereCollider,goo.BoxCollider,goo.PlaneCollider,goo.CylinderCollider,goo.PhysicsMaterial),goo.RigidBodyComponentHandler=function(t,o,e,n,i,r,s){"use strict";function a(){t.apply(this,arguments),this._type="RigidBodyComponent"}return a.prototype=Object.create(t.prototype),a.prototype.constructor=a,t._registerClass("rigidBody",a),a.prototype._prepare=function(t){return r.defaults(t,{mass:1,isKinematic:!1,velocity:[0,0,0],angularVelocity:[0,0,0],linearDrag:0,angularDrag:0})},a.prototype._create=function(){
return new o},a.prototype._remove=function(t){t.clearComponent("RigidBodyComponent")},a.prototype.update=function(o,e,n){return t.prototype.update.call(this,o,e,n).then(function(t){return t?(t.mass=e.mass,t.isKinematic=e.isKinematic,t.setVelocity(new s(e.velocity)),t.setAngularVelocity(new s(e.angularVelocity)),t.linearDamping=e.linearDrag,t.angularDamping=e.angularDrag,t._dirty=!0,t._initialized=!1,t):void 0})},a}(goo.ComponentHandler,goo.RigidBodyComponent,goo.BoundingBox,goo.ShapeCreatorMemoized,goo.rsvp,goo.ObjectUtil,goo.Vector3),"function"==typeof require&&(define("goo/addons/physicspack/PhysicsMaterial",[],function(){return goo.PhysicsMaterial}),define("goo/addons/physicspack/colliders/Collider",[],function(){return goo.Collider}),define("goo/addons/physicspack/colliders/BoxCollider",[],function(){return goo.BoxCollider}),define("goo/addons/physicspack/colliders/CylinderCollider",[],function(){return goo.CylinderCollider}),define("goo/addons/physicspack/colliders/MeshCollider",[],function(){return goo.MeshCollider}),define("goo/addons/physicspack/colliders/PlaneCollider",[],function(){return goo.PlaneCollider}),define("goo/addons/physicspack/colliders/SphereCollider",[],function(){return goo.SphereCollider}),define("goo/addons/physicspack/joints/PhysicsJoint",[],function(){return goo.PhysicsJoint}),define("goo/addons/physicspack/joints/BallJoint",[],function(){return goo.BallJoint}),define("goo/addons/physicspack/joints/HingeJoint",[],function(){return goo.HingeJoint}),define("goo/addons/physicspack/systems/AbstractPhysicsSystem",[],function(){return goo.AbstractPhysicsSystem}),define("goo/addons/physicspack/shapes/PhysicsPlaneDebugShape",[],function(){return goo.PhysicsPlaneDebugShape}),define("goo/addons/physicspack/util/Pool",[],function(){return goo.Pool}),define("goo/addons/physicspack/systems/PhysicsDebugRenderSystem",[],function(){return goo.PhysicsDebugRenderSystem}),define("goo/addons/physicspack/components/AbstractRigidBodyComponent",[],function(){return goo.AbstractRigidBodyComponent}),define("goo/addons/physicspack/components/ColliderComponent",[],function(){return goo.ColliderComponent}),define("goo/addons/physicspack/systems/ColliderSystem",[],function(){return goo.ColliderSystem}),define("goo/addons/physicspack/RaycastResult",[],function(){return goo.RaycastResult}),define("goo/addons/physicspack/components/RigidBodyComponent",[],function(){return goo.RigidBodyComponent}),define("goo/addons/physicspack/systems/PhysicsSystem",[],function(){return goo.PhysicsSystem}),define("goo/addons/physicspack/PhysicsRegister",[],function(){return goo.PhysicsRegister}),define("goo/addons/physicspack/handlers/ColliderComponentHandler",[],function(){return goo.ColliderComponentHandler}),define("goo/addons/physicspack/handlers/RigidBodyComponentHandler",[],function(){return goo.RigidBodyComponentHandler}));